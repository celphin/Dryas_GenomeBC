# DMRs with Metilene
# find way to search for short dense changes
# convert to gene names
# find differences seedling warming control
# seedling low and high arctic chambers
# mature flower vs seed set
#######################################

#Metilene
# https://www.bioinf.uni-leipzig.de/Software/metilene/Manual/#12_parameters
# https://www.bioinf.uni-leipzig.de/Software/metilene/Manual/#5_dmr_de-novo_annotation

##########################################
# copy methylation calling data over to project folder

tmux attach-session -t Seed
cp -vr /home/celphin/scratch/Dryas/Seedling_Methylseq/output/* /home/celphin/projects/rpp-rieseber/celphin/Dryas/Methylation_calling/Aug2022_Seedlings/

tmux attach-session -t Seed2
cp -vr /home/celphin/scratch/Dryas/May2021_Methylseq/output/*  /home/celphin/projects/rpp-rieseber/celphin/Dryas/Methylation_calling/May2021_Parents/

#####################################
# copy bedGraph files over

#---------------------------------------------
# seedlings

cd /home/celphin/scratch/Dryas/Seedling_Methylseq/output/bismark_methylation_calls/bedGraph/

cp -v SE_*.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings/input_bedGraphs/


#------------------------------------------
# mature flower plants
cd /home/celphin/scratch/Dryas/Seedling_Methylseq/output/bismark_methylation_calls/bedGraph/

MatFl_Cass_10W_60_544_F112581_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz  
MatFl_Cass_4C_4_524_F112579_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz  
MatFl_Cass_5W_130_525_F112580_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz 
# missing - MatFl_Cass_17C_175_576
MatFl_Fert_5C_97_1F_F112583_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz   
MatFl_Fert_6W_110_3F_F112584_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz   
MatFl_Mead_1C_33_446_F112577_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz   
MatFl_Mead_1W_116_444_F112578_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz  
MatFl_Will_3C_100_414_F112575_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz  
MatFl_Will_4W_13_417_F112576_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz  

# missing a CASS control plant!!

cp -v MatFl_*.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/

#---------------------------------------------
# equivalent seed set plants - bedGraphs
cd /home/celphin/scratch/Dryas/May2021_Methylseq/output/bismark_methylation_calls/bedGraph/

cp W1.F06.W1e5_CASS10W_544_60_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_Cass_10W_60_544.bedGraph.gz
cp C1.B05.C1d1_CASS4C_524_4_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_Cass_4C_4_524.bedGraph.gz
cp W1.A09.W1f10_CASS5W_525_130_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_Cass_5W_130_525.bedGraph.gz
cp C2.E10.C1h12_CASS17C_576_175_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_Cass_17C_175_576.bedGraph.gz
cp C1.G07.C1h7_FERT5C_1F_97_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_Fert_5C_97_1F.bedGraph.gz
cp W1.B08.W1f8_FERT6W_3F_110_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_Fert_6W_110_3F.bedGraph.gz
cp C1.H05.C1f3_MEAD1C_446_33_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_Mead_1C_33_446.bedGraph.gz
cp W1.E08.W1c9_MEAD1W_444_116_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_Mead_1W_116_444.bedGraph.gz
cp C1.H07.C1b8_WILL3C_414_100_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_WILL3C_414_100.bedGraph.gz
cp W1.C05.W1g1_WILL4W_417_13_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph.gz /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/Sen_WILL4W_417_13.bedGraph.gz

#--------------------
# unzip all
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/

gunzip -v *.bedGraph.gz

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings/input_bedGraphs/

gunzip -v *.bedGraph.gz

#-------------------------------
# combine warming and control seedlings

tmux new-session -s DMR
tmux attach-session -t DMR
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings/input_bedGraphs/

tmux attach-session -t DMR2
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/

salloc -c1 --time 2:50:00 --mem 120000m --account rpp-rieseber

module load StdEnv/2020
module load bedtools/2.30.0 

# make sorted bedgraph files

find . -name "*.bedGraph" -print > file_list.txt

while read name
do
bedtools sort -i ${name} >  ${name}_sorted.bedGraph
sort -c -k1,1 -k2,2n ${name}_sorted.bedGraph
cat ${name}_sorted.bedGraph | tr ' ' '\t' > ${name}_sorted_tab.bedGraph
done < file_list.txt

#-------------------------------
#get list of files
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings/input_bedGraphs/
find . -name "*W*_sorted_tab.bedGraph" -print > W_list.txt
find . -name "*C*_sorted_tab.bedGraph" -print > C_list.txt

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings/input_bedGraphs/
find . -name '*C_L*_sorted_tab.bedGraph' -print > LowC_list.txt
find . -name '*W_L*_sorted_tab.bedGraph' -print > LowW_list.txt
cat LowC_list.txt LowW_list.txt > Low_list.txt

find . -name '*C_H*_sorted_tab.bedGraph' -print > HighC_list.txt
find . -name '*W_H*_sorted_tab.bedGraph' -print > HighW_list.txt
cat HighC_list.txt HighW_list.txt > High_list.txt

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/
find . -name "Mat*_sorted_tab.bedGraph" -print > Mat_list.txt
find . -name "Sen*_sorted_tab.bedGraph" -print > Sen_list.txt


#################################################
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings/input_bedGraphs/

# replace ./ in file names
sed -i 's/\.\///g' W_list.txt
sed -i 's/\.\///g' C_list.txt

# replace ./ in file names
sed -i 's/\.\///g' W_list.txt
sed -i 's/\.\///g' C_list.txt

# make csv and space delimited files
sed -z 's/\n/ /g;s/,$/\n/'  W_list.txt > W_list_sp.txt
sed -z 's/\n/ /g;s/,$/\n/'  C_list.txt > C_list_sp.txt

sed -z 's/\n/,/g;s/,$/\n/'  W_list.txt > W_list_csv.csv
sed -z 's/\n/,/g;s/,$/\n/'  C_list.txt > C_list_csv.csv

# NOTE: one short in Warming list
#-------------------------------------
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings/input_bedGraphs/

# replace ./ in file names
sed -i 's/\.\///g' Low_list.txt
sed -i 's/\.\///g' High_list.txt

# replace ./ in file names
sed -i 's/\.\///g' Low_list.txt
sed -i 's/\.\///g' High_list.txt

# make csv and space delimited files
sed -z 's/\n/ /g;s/,$/\n/'  Low_list.txt > Low_list_sp.txt
sed -z 's/\n/ /g;s/,$/\n/'  High_list.txt > High_list_sp.txt

sed -z 's/\n/,/g;s/,$/\n/'  Low_list.txt > Low_list_csv.csv
sed -z 's/\n/,/g;s/,$/\n/'  High_list.txt > High_list_csv.csv


#-------------------------------------
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology/input_bedGraphs/

# replace ./ in file names
sed -i 's/\.\///g' Mat_list.txt
sed -i 's/\.\///g' Sen_list.txt

# replace ./ in file names
sed -i 's/\.\///g' Mat_list.txt
sed -i 's/\.\///g' Sen_list.txt

# make csv and space delimited files
sed -z 's/\n/ /g;s/,$/\n/'  Mat_list.txt > Mat_list_sp.txt
sed -z 's/\n/ /g;s/,$/\n/'  Sen_list.txt > Sen_list_sp.txt

sed -z 's/\n/,/g;s/,$/\n/'  Mat_list.txt > Mat_list_csv.csv
sed -z 's/\n/,/g;s/,$/\n/'  Sen_list.txt > Sen_list_csv.csv


########################################
# setup paramters

# Do1_01_a00001G00358V1.1 -plastocyanin-like domain protein - differentially expressed in both parents and seedlings

###########################################
# W and C seedlings
directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings"
NA="NA"
h1='W'
h2='C'

#-------------------------------
# low arctic and high arctic seedlings

# make sorted bedgraph files
directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings"
NA="NA"
h1='Low'
h2='High'

#-------------------------------
# mat flower and sen plants
directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology"
NA="NA"
h1='Mat'
h2='Sen'

#-------------------------------
in_metilene="metilene_"$h1"_"$h2".input"

#make bed file
# make sorted bedgraph files
cd "${directory}/input_bedGraphs/"

sed ':a;N;$!ba;s/\n/ /g' ${h1}_list.txt > h1files
sed ':a;N;$!ba;s/\n/ /g' ${h2}_list.txt > h2files

sed ':a;N;$!ba;s/\n/ /g' ${h1}_list.txt | \
sed 's/_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph_sorted_tab.bedGraph//g' > H1name

sed ':a;N;$!ba;s/\n/ /g' ${h2}_list.txt | \
sed -z 's/_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph_sorted_tab.bedGraph//g' > H2name

h1name=$(more H1name)
h2name=$(more H2name)

bedtools unionbedg -header -names $h1name $h2name -filler $NA -i $h1files $h2files \
| cut -f1,3- | sed 's/end/pos/' > "$in_metilene"


#-------------------------------------
# metilene input file

head -5 "$in_metilene" > subset.txt

grep '^c.*' subset.txt | wc -w
grep '^Q.*' subset.txt | wc -w
grep '^Q.*' subset.txt | wc -l

#header should be:
#chrom pos h1name h2name
# but the h2names are on new line
W_ALAS0W_8_265
	C_ALAS_00C_227

#edit to remove extra enter
nano "metilene_"$h1"_"$h2".input"

# check header again
head -5 "metilene_$h1_$h2.input" > subset2.txt

grep '^c.*' subset2.txt | wc -w
grep '^Q.*' subset2.txt | wc -w
grep '^Q.*' subset2.txt | wc -l

###########################################
# Run Metilene
# header of output
chr	start	end	q-value	 mean_methyl_diff	#CpGs	p-value_MWU	p-value_2D-KS	mean_g1	mean_g2

tmux new-session -s DMR
tmux attach-session -t DMR

salloc -c32 --time 2:50:00 --mem 120000m --account def-rieseber

module load StdEnv/2020
module load bedtools/2.30.0 

# parameters
# try
# maxdist (allowed nt distance between two CpGs within a DMR) 5
# mincpgs (minimum # of CpGs in a DMR) 3
# mindiff (minimum mean methylation difference for calling DMRs) 0.5

#directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings"
NA="NA"
h1='W'
h2='C'

directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings"
NA="NA"
h1='Low'
h2='High'

directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Phenology"
NA="NA"
h1='Mat'
h2='Sen'

directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs"
NA="NA"
h1='W'
h2='C'

maxdist=70
mincpgs=5
mindiff=4
threads=32
outputname=metilene_"$h1"_"$h2"_Sept2022_"${maxdist}"_"${mincpgs}"_"${mindiff}"
in_metilene="metilene_"$h1"_"$h2".input"

cd "${directory}"

/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene \
"${directory}/data/${in_metilene}" \
--maxdist ${maxdist} --mincpgs ${mincpgs} --minMethDiff ${mindiff} --mode 1 --threads ${threads} -a W -b C -v 0.2 > \
"${outputname}"

more "${outputname}"

#------------------------------------------
# want to elect only low p-values?
# perl filterOutput.pl -q <string>[-o <string>] [-p <n>] [-c <n>] [-d <n>] [-l <n>] [-a <string>] [-b <string>]
# q-value is the Bonferroni adjusted p-value
# need R installed with ggplot2

[INPUT]     -q          path/filename of metilene DMRs
                -o          path/prefix of output files (default: input_path/)
                -p          maximum (<) adj. p-value (q-value) for output of significant DMRs (default: 0.05)
                -c          minimum (>=) cpgs (default:10)
                -d          minimum mean methylation difference (>=) (default:0.1)
                -l          minimum length of DMR [nt] (>=) (post-processing, default: 0)
                -a          name of group A (default:"g1")
                -b          name of group B (default:"g2")


module load nixpkgs/16.09
module load gcc/7.3.0
module load r/3.6.0
module load gdal
module load udunits
module load python
export R_LIBS_USER=/home/celphin/R/x86_64-pc-linux-gnu-library/3.6/

minmeandiff=0.9
mincpgs=10
qval=1e-5

outputname="metilene_W_C_Sept2022_70_5_4"
outputname="metilene_W_C_Sept2022_70_5_0.7"
outputname="metilene_W_C_Sept2022_150_5_4"

perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl \
-q "${directory}/${outputname}" -p ${qval} -c ${mincpgs} -d ${minmeandiff} -a ${h1} -b ${h2} \
-o "${outputname}_${minmeandiff}"

# header of output
chr	start	end	q-value	 mean_methyl_diff	#CpGs	mean_g1	   mean_g2

# did it find: Do1_01_a00001:1,758,623-1,758,782

wc -l *.out

407 metilene_W_C_Sept2022_150_5_4_0.9_qval.1e-5.out
454 metilene_W_C_Sept2022_70_5_0.7_0.7_qval.0.001.out
385 metilene_W_C_Sept2022_70_5_4_0.9_qval.0.001.out

scp metilene_W_C_Sept2022_70_5_4_0.9_qval.0.001.out

# on local machine
cd /home/Owner/Desktop
scp -v celphin@cedar.computecanada.ca:/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_W_C_Sept2022_70_5_4_0.9_qval.0.001.out .


ID: Do1_a00028G00040V1.1
Do1_a00028	195312	195953	3.7444E-71	16.666478	102	42.327	25.66


Do1_03_a00002	5374897	5375464	3.338E-51	7.253257	106	37.734	30.481
Do1_06_a00001	16189522	16190157	6.2852E-47	8.453425	89	83.867	75.413
Do1_02_a00001	10400308	10401331	1.6681E-46	-6.510648	131	17.527	24.037
Do1_07_a00002	12442810	12443245	5.656E-45	-14.73753	54	57.641	72.379
ID: Do1_07_a00002G02343

Do1_07_a00002	13390289	13391396	6.7947E-45	10.292359	135	22.967	12.675
Do1_02_a00004	1315538	1316252	2.0881E-42	-7.663313	75	11.07	18.733


########################################
# find site specific DMRs

cd "${directory}/data/"

Site1="ALAS"
Site2="Alex"
Site3="SVAL"
Site4="LAT"

directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs"
NA="NA"
h1='W'
h2='C'

maxdist=70
mincpgs=5
mindiff=4
threads=32
outputname=metilene_"$h1"_"$h2"_Sept2022_"${maxdist}"_"${mincpgs}"_"${mindiff}"
in_metilene="metilene_"$h1"_"$h2".input"

minmeandiff=5
mincpgs=5
qval=0.005

# run site specific code at the end once before running what follows

#-----------------
#run metilene

cd "${directory}"

module load nixpkgs/16.09
module load intel/2018.3
module load bedtools/2.29.2

/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene \
"${directory}/data/${Site1}_$in_metilene" \
--maxdist ${maxdist} --mincpgs ${mincpgs} --minMethDiff ${mindiff} --mode 1 --threads ${threads} -a W -b C -v 0.2 > \
"${Site1}${outputname}"

/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene \
"${directory}/data/${Site2}_$in_metilene" \
--maxdist ${maxdist} --mincpgs ${mincpgs} --minMethDiff ${mindiff} --mode 1 --threads ${threads} -a W -b C -v 0.2 > \
"${Site2}${outputname}"

/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene \
"${directory}/data/${Site3}_$in_metilene" \
--maxdist ${maxdist} --mincpgs ${mincpgs} --minMethDiff ${mindiff} --mode 1 --threads ${threads} -a W -b C -v 0.2 > \
"${Site3}${outputname}"

/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene \
"${directory}/data/${Site4}_$in_metilene" \
--maxdist ${maxdist} --mincpgs ${mincpgs} --minMethDiff ${mindiff} --mode 1 --threads ${threads} -a W -b C -v 0.2 > \
"${Site4}${outputname}"

#------------------------------
#subset significant DMRs

module load nixpkgs/16.09
module load gcc/7.3.0
module load r/3.6.0
module load gdal
module load udunits
module load python
export R_LIBS_USER=/home/celphin/R/x86_64-pc-linux-gnu-library/3.6/

perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl \
-q "${directory}/${Site1}${outputname}" -p ${qval} -c ${mincpgs} -d ${minmeandiff} -a ${h1} -b ${h2} \
-o "${Site1}_${outputname}_${minmeandiff}"

perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl \
-q "${directory}/${Site2}${outputname}" -p ${qval} -c ${mincpgs} -d ${minmeandiff} -a ${h1} -b ${h2} \
-o "${Site2}_${outputname}_${minmeandiff}"

perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl \
-q "${directory}/${Site3}${outputname}" -p ${qval} -c ${mincpgs} -d ${minmeandiff} -a ${h1} -b ${h2} \
-o "${Site3}_${outputname}_${minmeandiff}"

perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl \
-q "${directory}/${Site4}${outputname}" -p ${qval} -c ${mincpgs} -d ${minmeandiff} -a ${h1} -b ${h2} \
-o "${Site4}_${outputname}_${minmeandiff}"

wc -l *.out


#######################################
# bedGraph intersection between sites
# https://bedtools.readthedocs.io/en/latest/content/tools/intersect.html

module load nixpkgs/16.09  
module load gcc/7.3.0
module load bedtools/2.29.2

cd "${directory}"

#--------------------------------
# All sites intersect with total
bedtools intersect -u -a "${outputname}_${minmeandiff}_qval.${qval}.bedgraph" -b "${Site1}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" | \
bedtools intersect -u -a stdin -b "${Site2}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" | \
bedtools intersect -u -a stdin -b "${Site3}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" | \
bedtools intersect -u -a stdin -b "${Site4}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" > \
"ALL_Sites_intersect_DMRs_${outputname}_${minmeandiff}_qval.${qval}.bedgraph"

#-----------------------------
# All sites intersect without total
bedtools intersect -u -a "${Site1}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" -b "${Site2}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" | \
bedtools intersect -u -a stdin -b "${Site3}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" | \
bedtools intersect -u -a stdin -b "${Site4}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" > \
"No_total_intersect_DMRs_${outputname}_${minmeandiff}_qval.${qval}.bedGraph"

#---------------------
# All sites intersect but Site 4
bedtools intersect -u -a "${Site1}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" -b "${Site2}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" | \
bedtools intersect -u -a stdin -b "${Site3}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" > \
"All_sites_not${Site4}_intersect_DMRs_${outputname}_${minmeandiff}_qval.${qval}.bedGraph"

#------------------------
# All sites intersect but Site 3
bedtools intersect -u -a "${Site1}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" -b "${Site2}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" | \
bedtools intersect -u -a stdin -b "${Site4}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" > \
"All_sites_not${Site3}_intersect_DMRs_${outputname}_${minmeandiff}_qval.${qval}.bedGraph"

#------------------------
# All sites intersect but Site 2
bedtools intersect -u -a "${Site1}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" -b "${Site3}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" | \
bedtools intersect -u -a stdin -b "${Site4}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" > \
"All_sites_not${Site2}_intersect_DMRs_${outputname}_${minmeandiff}_qval.${qval}.bedGraph"

#------------------------
# All sites intersect but Site 1
bedtools intersect -u -a "${Site2}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" -b "${Site3}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" | \
bedtools intersect -u -a stdin -b "${Site4}_${outputname}_${minmeandiff}_qval.${qval}.bedgraph" > \
"All_sites_not${Site1}_intersect_DMRs_${outputname}_${minmeandiff}_qval.${qval}.bedGraph"


###############################################
# Blast
# convert bedGraph files to bed files to fasta files for Blast

cd "${directory}"
mkdir blast
cd "${directory}"/blast

blastname="No_total_intersect_DMRs_${outputname}_${minmeandiff}_qval.${qval}"

cat "${directory}/${blastname}.bedGraph" | awk '{print $1 "\t" $2 "\t" $3}' > "${blastname}.bed"


#----------------------------
# add 500bp on each side of the DMR

awk '{$3+=1000}1' "${blastname}.bed" > "${blastname}_extended.bed"
awk '{$2-=1000}1' "${blastname}_extended.bed" > "${blastname}_extended2.bed"

#----------------------
# https://bedtools.readthedocs.io/en/latest/content/tools/getfasta.html
# bedtools getfasta [OPTIONS] -fi <input FASTA> -bed <BED/GFF/VCF>

sed -e 's/ /\t/g' "${blastname}_extended2.bed" > "${blastname}_extended2_tab.bed"

bedtools getfasta -fi /home/celphin/scratch/Dryas/Dryas_octopetala_reference/genomes/Dryas_octopetala_H1.supercontigs.fa \
-bed "${blastname}_extended2_tab.bed" \
> "${blastname}_extended.fasta"

more "${blastname}_extended.fasta"

#--------------------------------------
# run blast

cd "${directory}/blast/"

module load StdEnv/2020
module load gcc/9.3.0
module load blast+/2.12.0

# https://www.metagenomics.wiki/tools/blast/blastn-output-format-6

# blast to ncbi database
blastn -db nt -query "${blastname}_extended.fasta" -out "blast_${blastname}_extended.out" -remote -outfmt "6 qseqid stitle"

# blast to gff3 Dryas genome
blastn -query "${blastname}_extended.fasta" -subject /home/celphin/projects/rpp-rieseber/celphin/Dryas/Reference_genomes/fasta/Dryas_octopetala_H1.transcript.fa -outfmt 6 -out "Dryas_blast_${blastname}_extended.out"

################################################
# choose a DMR and get all differential methylation for that region - subset input file

# Do1_05_a00003   1152846 	1152987 # amidase
# Do1_07_a00002   11718523        11718688  
# Do1_07_a00002   12442455        12443488 
# Do1_01_a00004   10490278        10490516 


#RNAseq
Do1_01_a00001:1,762,189-1,762,507 # look at these for seedling methylation
Do1_01_a00001:1,758,636-1,758,795

################################################
#https://www.geeksforgeeks.org/awk-command-unixlinux-examples/
# https://www.tim-dennis.com/data/tech/2016/08/09/using-awk-filter-rows.html
#grep "^${chrom}" metilene_W_C.input > "${chrom}.txt"
#awk -F "\t" '{print $1}' "${chrom}.txt"
#awk -F "\t" '{print $2}' "${chrom}.txt"
#awk -F "\t" '{print $0}' "${chrom}.txt"
#awk -F "\t" '{ if(($2 >= $start) && ($2 <= $end)) { print } }' "${chrom}.txt" > "${chrom}_${start}_${end}_2.txt"

directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings"

chrom="Do1_05_a00003"
start=1152846
end=1152987

cd "${directory}/data/"
grep "^${chrom}" metilene_W_C.input > "${chrom}.txt"
awk -F "\t" '{ if(($2 >= 1152846) && ($2 <= 1152987)) { print } }' "${chrom}.txt"  > "${chrom}_${start}_${end}.txt"

#----------------------------------
# check name order - parents

sed 's/^W..........._/"W_/g' ./data/W_list.txt | \
sed 's/^W.........._/"W_/g' | \
sed 's/^W........_/"W_/g' | \
sed 's/^W......._/"_/g' | \
sed 's/_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph_sorted_tab.bedGraph/", /g' | \
sed ':a;N;$!ba;s/\n/ /g'

"W_CASS_04W_519",  "W_WILL7W_448_107",  "W_FERT14W_6F_126",  "_LATJ_04W_188",  "W_LATC1W_12_219",  "W_ALAS0W_14_249",  "W_LATC9W_11_216",  "W_DRY6W_31_147",  "W_SVAL6W_6_274",  "W_SVAL18W_18_271",  "W_LATD4W_8_211",  "W_MEAD2W_450_70",  "_ALAS_00W_228",  "W_DRY9W_50_185",  "W_LATD2W_5_206",  "W_ALAS0W_8_265",  "W_WILL5W_421_154",  "W_LATJ_02W_193",  "W_ALAS0W_7_263",  "W_MEAD6W_466_163",  "W_WILL4W_417_13",  "W_MEAD1W_444_116",  "W_MEAD_08W_4R0",  "W_LATC3W_16_220",  "W_LATD2W_4_212",  "W_WILL1W_403_67",  "W_SVAL16W_16_277",  "W_DRY1W_3_39",  "W_DRY3W_15_69",  "W_CASS9W_539_128",  "W_ALAS0W_18_248",  "W_SVAL_0W_267",  "W_FERT22W_12F_111",  "W_CASS17W_574_137",  "W_CASS10W_544_60",  "W_ALAS0W_15_242",  "W_ALAS0W_16_239",  "W_FERT30W_14F_40",  "W_LATD4W_9_207",  "W_MEAD7W_470_173",  "W_ALAS0W_17_235",  "W_SVAL_0W_270",  "W_CASS7W_600_19",  "W_SVAL8W_8_272",  "_ALAS_00W_232",  "W_DRY8W_45_155",  "W_FERT6W_3F_110",  "W_LATC5W_18_190",  "W_CASS5W_525_130",  "W_ALAS0W_3_236",  "W_WILL10W_437_84", 

sed 's/^C..........._/"C_/g' ./data/C_list.txt | \
sed 's/^C.........._/"C_/g' | \
sed 's/^C........_/"C_/g' | \
sed 's/^C......._/"C_/g' | \
sed 's/_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph_sorted_tab.bedGraph/", /g' | \
sed ':a;N;$!ba;s/\n/ /g'

"C_WILL5C_422_31",  "C_CASS10C_548_144",  "C_CASS4C_524_4",  "C_FERT39C_20F_71",  "C_FERT5C_1F_97",  "C_ALAS_00C_227",  "C_SVAL16C_16_276",  "C_CASS8C_535_54",  "C_ALAS0C_10_246",  "C_DRY9C_53_149",  "C_CASS_09C_541",  "C_MEAD7C_473_95",  "C_MEAD_03C_1R0",  "C_MEAD2C_451_76",  "C_ALAS0C_13_254",  "C_LATD5C_2_201",  "C_LATD2C_7_209",  "C_WILL7C_445_125",  "C_LATJ_00C_187",  "C_MEAD1C_446_33",  "C_ALAS0C_18_229",  "C_DRY5C_28_92",  "C_DRY2C_10_52",  "C_LATD2C_6_198",  "C_LATD1C_4_223",  "C_SVAL_0C_268",  "C_SVAL_0C_269",  "C_WILL10C_440_16",  "C_LATD2C_1_203",  "C_LATD5C_5_191",  "C_SVAL12C_12_273",  "C_FERT13C_7F_112",  "C_LATJ_02C_194",  "C_ALAS0C_19_261",  "C_CASS17C_576_175",  "C_DRY10C_60_41",  "C_MEAD6C_468_22",  "C_WILL3C_414_100",  "C_SVAL49C_49_278",  "C_FERT31C_15F_170",  "C_ALAS_00C_231",  "C_SVAL8C_8_275",  "C_ALAS0C_5_238",  "C_ALAS0C_12_256",  "C_LATD4C_3_196",  "C_ALAS0C_4_240",  "C_CASS5C_529_159",  "C_DRY4C_23_82",  "C_LATD5C_20_199",  "C_WILL1C_406_152",  "C_ALAS0C_3_258"

#---------------------------------------
# seedlings

sed 's/^SE_/"W_/g' ./data/W_list.txt | \
sed 's/_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph_sorted_tab.bedGraph/", /g' | \
sed ':a;N;$!ba;s/\n/ /g'

"W_L_W_H_219_104_F112567",  "W_L_W_L_198_34_F112563",  "W_L_W_L_219_42_F112557",  "W_L_W_L_190_43_F112556",  "W_L_W_H_219_105J_F112571",  "W_L_W_H_219_105_F112564",  "W_T_W_H_228_95_F112570",

sed 's/^SE_/"C_/g' ./data/C_list.txt | \
sed 's/_R1_val_1_bismark_bt2_pe.deduplicated.bedGraph_sorted_tab.bedGraph/", /g' | \
sed ':a;N;$!ba;s/\n/ /g'

"C_L_C_H_191_100_F112569",  "C_L_C_H_187_98_F112565",  "C_L_C_L_187_38_F112560",  "C_T_C_L_238_47_F112559",  "C_A_C_L_125_11_F112561",  "C_L_C_L_198_35_F112558",  "C_A_C_L_170_5_F112555",  "C_L_C_H_194_92_F112566",  "C_L_C_H_191_102_F112568",  "C_L_C_H_194_92J_F112572"

#----------------------------------
# run in R

module load StdEnv/2020
module load r/4.2.1
module load gdal
module load udunits
module load python
export R_LIBS_USER=/home/celphin/R/x86_64-pc-linux-gnu-library/4.2.1/

R

directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings"
#directory="/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs"
h1='W'
h2='C'
maxdist=50
mincpgs=5
mindiff=0.7
threads=32
qval=0.001
chrom="Do1_05_a00003"
start=1152846
end=1152987


#outputname=metilene_$h1_$h2_Sept2022_${maxdist}_${mincpgs}_${mindiff}
#in_metilene="metilene_$h1_$h2.input"

setwd (directory)

#install.packages('ggplot2')
#install.packages('ggpubr')

library(ggplot2)
library(ggpubr)

#import data
data <- read.table(paste0(directory,"/data/",chrom,"_",start,"_",end,".txt"), header = FALSE)

# parents
#colnames(data) <- c("chrom", "pos", "W_CASS_04W_519",  "W_WILL7W_448_107",  "W_FERT14W_6F_126",  "W_LATJ_04W_188",  "W_LATC1W_12_219",  "W_ALAS0W_14_249",  "W_LATC9W_11_216",  "W_DRY6W_31_147",  "W_SVAL6W_6_274",  "W_SVAL18W_18_271",  "W_LATD4W_8_211",  "W_MEAD2W_450_70",  "W_ALAS_00W_228",  "W_DRY9W_50_185",  "W_LATD2W_5_206",  "W_ALAS0W_8_265",  "W_WILL5W_421_154",  "W_LATJ_02W_193",  "W_ALAS0W_7_263",  "W_MEAD6W_466_163",  "W_WILL4W_417_13",  "W_MEAD1W_444_116",  "W_MEAD_08W_4R0",  "W_LATC3W_16_220",  "W_LATD2W_4_212",  "W_WILL1W_403_67",  "W_SVAL16W_16_277",  "W_DRY1W_3_39",  "W_DRY3W_15_69",  "W_CASS9W_539_128",  "W_ALAS0W_18_248",  "W_SVAL_0W_267",  "W_FERT22W_12F_111",  "W_CASS17W_574_137",  "W_CASS10W_544_60",  "W_ALAS0W_15_242",  "W_ALAS0W_16_239",  "W_FERT30W_14F_40",  "W_LATD4W_9_207",  "W_MEAD7W_470_173",  "W_ALAS0W_17_235",  "W_SVAL_0W_270",  "W_CASS7W_600_19",  "W_SVAL8W_8_272",  "W_ALAS_00W_232",  "W_DRY8W_45_155",  "W_FERT6W_3F_110",  "W_LATC5W_18_190",  "W_CASS5W_525_130",  "W_ALAS0W_3_236",  "W_WILL10W_437_84", "C_WILL5C_422_31",  "C_CASS10C_548_144",  "C_CASS4C_524_4",  "C_FERT39C_20F_71",  "C_FERT5C_1F_97",  "C_ALAS_00C_227",  "C_SVAL16C_16_276",  "C_CASS8C_535_54",  "C_ALAS0C_10_246",  "C_DRY9C_53_149",  "C_CASS_09C_541",  "C_MEAD7C_473_95",  "C_MEAD_03C_1R0",  "C_MEAD2C_451_76",  "C_ALAS0C_13_254",  "C_LATD5C_2_201",  "C_LATD2C_7_209",  "C_WILL7C_445_125",  "C_LATJ_00C_187",  "C_MEAD1C_446_33",  "C_ALAS0C_18_229",  "C_DRY5C_28_92",  "C_DRY2C_10_52",  "C_LATD2C_6_198",  "C_LATD1C_4_223",  "C_SVAL_0C_268",  "C_SVAL_0C_269",  "C_WILL10C_440_16",  "C_LATD2C_1_203",  "C_LATD5C_5_191",  "C_SVAL12C_12_273",  "C_FERT13C_7F_112",  "C_LATJ_02C_194",  "C_ALAS0C_19_261",  "C_CASS17C_576_175",  "C_DRY10C_60_41",  "C_MEAD6C_468_22",  "C_WILL3C_414_100",  "C_SVAL49C_49_278",  "C_FERT31C_15F_170",  "C_ALAS_00C_231",  "C_SVAL8C_8_275",  "C_ALAS0C_5_238",  "C_ALAS0C_12_256",  "C_LATD4C_3_196",  "C_ALAS0C_4_240",  "C_CASS5C_529_159",  "C_DRY4C_23_82",  "C_LATD5C_20_199",  "C_WILL1C_406_152",  "C_ALAS0C_3_258")

# seedlings
colnames(data) <- c("chrom", "pos", "W_L_W_H_219_104_F112567",  "W_L_W_L_198_34_F112563",  "W_L_W_L_219_42_F112557",  "W_L_W_L_190_43_F112556",  "W_L_W_H_219_105J_F112571",  "W_L_W_H_219_105_F112564",  "W_T_W_H_228_95_F112570", "C_L_C_H_191_100_F112569",  "C_L_C_H_187_98_F112565",  "C_L_C_L_187_38_F112560",  "C_T_C_L_238_47_F112559",  "C_A_C_L_125_11_F112561",  "C_L_C_L_198_35_F112558",  "C_A_C_L_170_5_F112555",  "C_L_C_H_194_92_F112566",  "C_L_C_H_191_102_F112568",  "C_L_C_H_194_92J_F112572")

datat <-  as.data.frame(t(as.matrix(data)))

# parents
#datat$ID <- c("chrom", "pos", "W_CASS_04W_519",  "W_WILL7W_448_107",  "W_FERT14W_6F_126",  "W_LATJ_04W_188",  "W_LATC1W_12_219",  "W_ALAS0W_14_249",  "W_LATC9W_11_216",  "W_DRY6W_31_147",  "W_SVAL6W_6_274",  "W_SVAL18W_18_271",  "W_LATD4W_8_211",  "W_MEAD2W_450_70",  "W_ALAS_00W_228",  "W_DRY9W_50_185",  "W_LATD2W_5_206",  "W_ALAS0W_8_265",  "W_WILL5W_421_154",  "W_LATJ_02W_193",  "W_ALAS0W_7_263",  "W_MEAD6W_466_163",  "W_WILL4W_417_13",  "W_MEAD1W_444_116",  "W_MEAD_08W_4R0",  "W_LATC3W_16_220",  "W_LATD2W_4_212",  "W_WILL1W_403_67",  "W_SVAL16W_16_277",  "W_DRY1W_3_39",  "W_DRY3W_15_69",  "W_CASS9W_539_128",  "W_ALAS0W_18_248",  "W_SVAL_0W_267",  "W_FERT22W_12F_111",  "W_CASS17W_574_137",  "W_CASS10W_544_60",  "W_ALAS0W_15_242",  "W_ALAS0W_16_239",  "W_FERT30W_14F_40",  "W_LATD4W_9_207",  "W_MEAD7W_470_173",  "W_ALAS0W_17_235",  "W_SVAL_0W_270",  "W_CASS7W_600_19",  "W_SVAL8W_8_272",  "W_ALAS_00W_232",  "W_DRY8W_45_155",  "W_FERT6W_3F_110",  "W_LATC5W_18_190",  "W_CASS5W_525_130",  "W_ALAS0W_3_236",  "W_WILL10W_437_84", "C_WILL5C_422_31",  "C_CASS10C_548_144",  "C_CASS4C_524_4",  "C_FERT39C_20F_71",  "C_FERT5C_1F_97",  "C_ALAS_00C_227",  "C_SVAL16C_16_276",  "C_CASS8C_535_54",  "C_ALAS0C_10_246",  "C_DRY9C_53_149",  "C_CASS_09C_541",  "C_MEAD7C_473_95",  "C_MEAD_03C_1R0",  "C_MEAD2C_451_76",  "C_ALAS0C_13_254",  "C_LATD5C_2_201",  "C_LATD2C_7_209",  "C_WILL7C_445_125",  "C_LATJ_00C_187",  "C_MEAD1C_446_33",  "C_ALAS0C_18_229",  "C_DRY5C_28_92",  "C_DRY2C_10_52",  "C_LATD2C_6_198",  "C_LATD1C_4_223",  "C_SVAL_0C_268",  "C_SVAL_0C_269",  "C_WILL10C_440_16",  "C_LATD2C_1_203",  "C_LATD5C_5_191",  "C_SVAL12C_12_273",  "C_FERT13C_7F_112",  "C_LATJ_02C_194",  "C_ALAS0C_19_261",  "C_CASS17C_576_175",  "C_DRY10C_60_41",  "C_MEAD6C_468_22",  "C_WILL3C_414_100",  "C_SVAL49C_49_278",  "C_FERT31C_15F_170",  "C_ALAS_00C_231",  "C_SVAL8C_8_275",  "C_ALAS0C_5_238",  "C_ALAS0C_12_256",  "C_LATD4C_3_196",  "C_ALAS0C_4_240",  "C_CASS5C_529_159",  "C_DRY4C_23_82",  "C_LATD5C_20_199",  "C_WILL1C_406_152",  "C_ALAS0C_3_258")

# seedlings
datat$ID < c("chrom", "pos", "W_L_W_H_219_104_F112567",  "W_L_W_L_198_34_F112563",  "W_L_W_L_219_42_F112557",  "W_L_W_L_190_43_F112556",  "W_L_W_H_219_105J_F112571",  "W_L_W_H_219_105_F112564",  "W_T_W_H_228_95_F112570", "C_L_C_H_191_100_F112569",  "C_L_C_H_187_98_F112565",  "C_L_C_L_187_38_F112560",  "C_T_C_L_238_47_F112559",  "C_A_C_L_125_11_F112561",  "C_L_C_L_198_35_F112558",  "C_A_C_L_170_5_F112555",  "C_L_C_H_194_92_F112566",  "C_L_C_H_191_102_F112568",  "C_L_C_H_194_92J_F112572")

datat <- datat[-c(1,2),]

#factors to numeric
X <- length(datat)
factorToNumeric <- function(f) as.numeric(as.character(f))
datat[1:X] <- lapply(datat[1:X], factorToNumeric)

# sum rows
datat$total <- rowSums(datat[1:X], na.rm=TRUE)
datat$ID <- rownames(datat)

mydata <- as.data.frame(cbind(datat$ID ,datat$total))

colnames(mydata) <- c("ID", "TotalMeth")

# split ID

q <- as.data.frame(t(as.matrix(as.data.frame((strsplit(as.character(mydata$ID), "_"))))))
mydata <- cbind(mydata, q)

# parents
colnames(mydata) <- c("ID", "TotalMeth","Treat", "SitePlot", "Plot", "Plant")

# seedlings
colnames(mydata) <- c("ID", "TotalMeth","Treat", "Site", "Treat2", "Chamber", "Mother", "Pot")

#makes sites - parents
unique(mydata$SitePlot) # parent

mydata$Site <- sub('ALAS.*', "ALASKA", mydata$SitePlot, ignore.case = FALSE)
mydata$Site <- sub('LAT.*', "SWEDEN", mydata$Site, ignore.case = FALSE)
mydata$Site <- sub('SVAL.*', "SVALBARD", mydata$Site, ignore.case = FALSE)

mydata$Site <- sub('CASS.*', "NUNAVUT", mydata$Site, ignore.case = FALSE)
mydata$Site <- sub('MEAD.*', "NUNAVUT", mydata$Site, ignore.case = FALSE)
mydata$Site <- sub('DRY.*', "NUNAVUT", mydata$Site, ignore.case = FALSE)
mydata$Site <- sub('FERT.*', "NUNAVUT", mydata$Site, ignore.case = FALSE)
mydata$Site <- sub('WILL.*', "NUNAVUT", mydata$Site, ignore.case = FALSE)


mydata$sSite <- sub('ALAS.*', "ALASKA", mydata$SitePlot, ignore.case = FALSE)
mydata$sSite <- sub('LAT.*', "SWEDEN", mydata$Site, ignore.case = FALSE)
mydata$sSite <- sub('SVAL.*', "SVALBARD", mydata$Site, ignore.case = FALSE)

mydata$sSite <- sub('CASS.*', "CASS", mydata$Site, ignore.case = FALSE)
mydata$sSite <- sub('MEAD.*', "MEAD", mydata$Site, ignore.case = FALSE)
mydata$sSite <- sub('DRY.*', "DRY", mydata$Site, ignore.case = FALSE)
mydata$sSite <- sub('FERT.*', "FERT", mydata$Site, ignore.case = FALSE)
mydata$sSite <- sub('WILL.*', "WILL", mydata$Site, ignore.case = FALSE)

# seedlings
mydata$Site <- sub('^A', "NUNAVUT", mydata$Site, ignore.case = FALSE)
mydata$Site <- sub('^T', "ALASKA", mydata$Site, ignore.case = FALSE)
mydata$Site <- sub('^L', "SWEDEN", mydata$Site, ignore.case = FALSE)


unique(mydata$Site)

# plots
mydata$TotalMeth <- as.numeric(as.character(mydata$TotalMeth))

jpeg(paste0(directory,"/SE_Gene_specific_",chrom,"_",start,"_",end,".jpg"), width = 700, height = 500)
ggboxplot(mydata, x = "Site", y = "TotalMeth",  color = "Treat", add = "jitter", shape = "Treat")
dev.off()

############################################
# these are the best plots below

#make Plot unique to Site
mydata[(ncol(mydata)+1)] <- paste(mydata$Site,mydata$Treat, sep=".")
names(mydata)[(ncol(mydata))] <- "MixPlot"
unique(mydata$MixPlot)
length(unique(mydata$MixPlot))

#make Plot unique to Region
mydata[(ncol(mydata)+1)] <- paste(mydata$Region,mydata$Treat, sep=".")
names(mydata)[(ncol(mydata))] <- "RegPlot"
unique(mydata$RegPlot)
length(unique(mydata$RegPlot))

mydata$MixPlot <- as.factor(mydata$MixPlot)
mydata$RegPlot <- as.factor(mydata$RegPlot)
mydata$Treat <- as.factor(mydata$Treat)

#colour
#colour <- c("blue", "red","blue", "red","blue", "red","blue", "red","blue", "red","blue", "red","blue", "red","blue", "red")
colour_reg <- c("blue", "red","blue", "red","blue", "red","blue", "red")

colour <- c("blue", "red", "blue","blue", "red") # seedlings

#     par(mar = c(bottom, left, top, right))
# default: par(mar = c(5.1, 4.1, 4.1, 2.1))

jpeg(paste0(directory,"/SE_Gene_specific_stripchart6_",chrom,"_",start,"_",end,".jpg"), width = 1700, height = 1500)
par(mgp=c(3,3,0))
par(mar = c(35, 20, 4.1, 2.1))
plot(TotalMeth~MixPlot, data = mydata, cex=1.5, ylim =c(min(mydata$TotalMeth, na.rm=TRUE),max(mydata$TotalMeth, na.rm=TRUE)), xlab = "", ylab="", col=colour, las=2, cex.lab=5, cex.axis=5)
stripchart(TotalMeth~MixPlot, vertical = TRUE, method = "jitter", pch = 16, cex = 3,
           col = "black", data = mydata, add=TRUE)
mtext(side=1, text="", line=30, cex=5)
mtext(side=2, text=paste0("Amidase Gene"," DNA Methylation"), line=15, cex=5)
dev.off()

jpeg(paste0(directory,"/SE_Gene_specific_stripchart7_",chrom,"_",start,"_",end,".jpg"), width = 1700, height = 1500)
par(mgp=c(3,3,0))
par(mar = c(15, 20, 4.1, 2.1))
plot(TotalMeth~RegPlot, data = mydata, cex=1.5, ylim =c(min(mydata$TotalMeth, na.rm=TRUE),max(mydata$TotalMeth, na.rm=TRUE)), xlab = "", ylab="", col=colour_reg, las=2, cex.lab=5, cex.axis=5)
stripchart(TotalMeth~RegPlot, vertical = TRUE, method = "jitter", pch = 16, cex = 3,
           col = "black", data = mydata, add=TRUE)
mtext(side=1, text="Site", line=10, cex=5)
mtext(side=2, text=paste0(chrom," DNA Methylation"), line=15, cex=5)
dev.off()

jpeg(paste0(directory,"/SE_Gene_specific_stripchart8_",chrom,"_",start,"_",end,".jpg"), width = 1700, height = 1500)
par(mgp=c(3,3,0))
par(mar = c(15, 20, 4.1, 2.1))
plot(TotalMeth~Treat, data = mydata, cex=1.5, ylim =c(min(mydata$TotalMeth, na.rm=TRUE),max(mydata$TotalMeth, na.rm=TRUE)), xlab = "", ylab="", col=colour_reg, las=2, cex.lab=5, cex.axis=5)
stripchart(TotalMeth~Treat, vertical = TRUE, method = "jitter", pch = 16, cex = 3,
           col = "black", data = mydata, add=TRUE)
mtext(side=1, text="Warming Treatment", line=10, cex=5)
mtext(side=2, text=paste0("Amidase Gene"," DNA Methylation"), line=15, cex=5)
dev.off()

###################################################
#linear mixed effect models (lme)

#install.packages('nlme')
#install.packages('lme4')
#install.packages('lmerTest')
#install.packages('visreg')

library(nlme) #lme
library(lme4) #lmer
library(lmerTest) 
library(visreg)

#Variables for assignment
unique(mydata$Site) #random factor - Site name
unique(mydata$Treat) #fixed effect - warming chamber(OTC) or control
unique(mydata$Plot) #random factor - Plot number
unique(mydata$Plant) # sample ID from Plot

#log transform TotalMeth
mydata$log.TotalMeth  <- log(mydata$TotalMeth)

#how does TotalMeth vary with Treat

jpeg(paste0(directory,"/Gene_specific_stripchart1_",chrom,"_",start,"_",end,".jpg"), width = 700, height = 500)
plot(TotalMeth~Treat, data = mydata, cex=1.2,ylab="Total Methylation")
stripchart(TotalMeth~Treat, vertical = TRUE, method = "jitter", pch = 3,cex.lab=1.5,cex.axis=1.2,
           col = "blue", data = mydata, add=TRUE)
dev.off()


#how does TotalMeth vary with MixPlot
jpeg(paste0(directory,"/Gene_specific_stripchart2_",chrom,"_",start,"_",end,".jpg"), width = 700, height = 500)
plot(TotalMeth~MixPlot, data = mydata, cex=1.2,ylab="Total Methylation")
stripchart(TotalMeth~MixPlot, vertical = TRUE, method = "jitter", pch = 3,cex.lab=1.5,cex.axis=1.2,
           col = "blue", data = mydata, add=TRUE)
dev.off()

#how does log(TotalMeth) vary with Treat
jpeg(paste0(directory,"/Gene_specific_stripchart3_",chrom,"_",start,"_",end,".jpg"), width = 700, height = 500)
plot(log.TotalMeth~Treat, data = mydata, cex=1.2, xlab = "Warming Treat", ylab="log(Specific Leaf Area (mm^2/mg)")
stripchart(log.TotalMeth~Treat, vertical = TRUE, method = "jitter", pch = 3,cex.lab=1.5,cex.axis=1.2,
           col = "blue", data = mydata, add=TRUE)
dev.off()

#variables to include in linear mixed model
fix1.warming <- mydata$MixPlot
response.TotalMethlog <- mydata$log.TotalMeth
response.TotalMeth <- mydata$TotalMeth
rand1.Site <- mydata$Site

#linear mixed models
z <- lme(response.TotalMeth ~ fix1.warming, random = ~ 1|rand1.Site , data = mydata, na.action = na.exclude)

#with log transformed SLA values
#z1 <- lme(response.TotalMethlog ~ fix1.warming, random = ~ 1|rand1.Site , data = mydata, na.action = na.exclude)

#not including random effects - for interest
#z2 <- lm(response.TotalMethlog ~ fix1.warming, data = mydata, na.action = na.exclude)

# parameter estimates
summary(z)
#summary(z1)
#summary(z2)

# conf. intervals for fixed effects and variances
intervals(z)   
#intervals(z1) 

# Plot of residuals against predicted values
plot(z)          
#plot(z1)

#are residuals normally distributed?
hist(resid(z))
#hist(resid(z1))

# variance components for random effects  
VarCorr(z)            
#VarCorr(z1)               

# Tests of fixed effects (fitted sequentially if  more than 1 fixed effect)
anova(z)            
#anova(z1)

jpeg(paste0(directory,"/Gene_specific_stripchart4_",chrom,"_",start,"_",end,".jpg"), width = 700, height = 500)
visreg(z, xvar = "fix1.warming", xlab="Warming Treat", ylab="log(Specific Leaf Area (mm^2/mg)")
dev.off()

jpeg(paste0(directory,"/Gene_specific_stripchart5_",chrom,"_",start,"_",end,".jpg"), width = 700, height = 500)
plot(fitted(z)~Treat, data = mydata, cex=1.2, ylim =c(min(mydata$TotalMeth, na.rm=TRUE),max(mydata$TotalMeth, na.rm=TRUE)), xlab = "Warming Treat", ylab="DNA Methylation")
stripchart(TotalMeth~Treat, vertical = TRUE, method = "jitter", pch = 16, cex.lab=1.5,cex.axis=1.2,
           col = "blue", data = mydata, add=TRUE)
dev.off()


##########################################
# on local machine
cd /home/Owner/Desktop
scp -v celphin@cedar.computecanada.ca:/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/Gene_specific_stripchart*_Do1_05_a00003*.jpg .
scp -v celphin@cedar.computecanada.ca:/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/Sept2022_Seedlings/SE_Gene_specific_stripchart*.jpg .

#################################################
#################################################

#find matches between studies

# https://stackoverflow.com/questions/13272717/inner-join-on-two-text-files
#https://itectec.com/ubuntu/ubuntu-awk-compare-2-files-and-print-columns-from-both-files/ 

# this returns all rows from second file that match the first column of first file
awk 'NR==FNR {a[$1]; next} $1 in a {print $0, a[$2]}' OFS='\t' LAT_DMRs_qval.0.05.out metilene_qval.0.05.out > LAT_Total.txt
# returns all that match for the 'chrom'



#################################################
# only need to run once per folder before site specific data will run

grep ".*${Site1}.*" "${h1}_list.txt" > "${Site1}_${h1}_list.txt"
grep ".*${Site1}.*" "${h2}_list.txt" > "${Site1}_${h2}_list.txt"

grep -E "CASS"\|"DRY"\|"MEAD"\|"WILL"\|"FERT" "${h1}_list.txt" > "${Site2}_${h1}_list.txt"
grep -E "CASS"\|"DRY"\|"MEAD"\|"WILL"\|"FERT" "${h2}_list.txt" > "${Site2}_${h2}_list.txt"

grep ".*${Site3}.*" "${h1}_list.txt" > "${Site3}_${h1}_list.txt"
grep ".*${Site3}.*" "${h2}_list.txt" > "${Site3}_${h2}_list.txt"

grep ".*${Site4}.*" "${h1}_list.txt" > "${Site4}_${h1}_list.txt"
grep ".*${Site4}.*" "${h2}_list.txt" > "${Site4}_${h2}_list.txt"
#--------------------

${Site1}_${h1}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site1}_${h1}_list.txt")
${Site1}_${h2}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site1}_${h2}_list.txt")

${Site2}_${h1}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site2}_${h1}_list.txt")
${Site2}_${h2}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site2}_${h2}_list.txt")

${Site3}_${h1}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site3}_${h1}_list.txt")
${Site3}_${h2}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site3}_${h2}_list.txt")

${Site4}_${h1}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site4}_${h1}_list.txt")
${Site4}_${h2}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site4}_${h2}_list.txt")

#-----------------------------
# need to format names here for each location
# download and edit in Excel: {Site}_W/C_list.txt
# files here: /~/Cassandra/PhD/GenomeBC_Dryas/Wild_Dryas_WGBS/June2022_DMRs/File_names/Site_specific/
# - edit to clean names
	- =MID(A1,FIND("_",A1)+1,256)
	- =RIGHT(A1,(FIND(" ",B1,1)-1))
	- Add W/C to the front = CONCATENATE("X",C1) 

# retranspose into a row?
# save as csv

${Site1}_${h1}name=$(tr ',' ' ' < "${Site1}_${h1}_list_transpose.csv")
${Site1}_${h2}name=$(tr ',' ' ' < "${Site1}_${h2}_list_transpose.csv")

${Site2}_${h1}name=$(tr ',' ' ' < "${Site2}_${h1}_list_transpose.csv")
${Site2}_${h2}name=$(tr ',' ' ' < "${Site2}_${h2}_list_transpose.csv")

${Site3}_${h1}name=$(tr ',' ' ' < "${Site3}_${h1}_list_transpose.csv")
${Site3}_${h2}name=$(tr ',' ' ' < "${Site3}_${h2}_list_transpose.csv")

${Site4}_${h1}name=$(tr ',' ' ' < "${Site4}_${h1}_list_transpose.csv")
${Site4}_${h2}name=$(tr ',' ' ' < "${Site4}_${h2}_list_transpose.csv")

#--------------------------
tmux new-session -s DMR 
tmux attach-session -t DMR

salloc -c10 --time 3:00:00 --mem 120000m --account def-rieseber

module load nixpkgs/16.09
module load intel/2018.3
module load bedtools/2.29.2

# make sorted bedgraph files
cd "${directory}/data/"
${Site1}_${h1}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site1}_${h1}_list.txt")
${Site1}_${h2}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site1}_${h2}_list.txt")

${Site2}_${h1}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site2}_${h1}_list.txt")
${Site2}_${h2}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site2}_${h2}_list.txt")

${Site3}_${h1}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site3}_${h1}_list.txt")
${Site3}_${h2}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site3}_${h2}_list.txt")

${Site4}_${h1}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site4}_${h1}_list.txt")
${Site4}_${h2}files=$(sed ':a;N;$!ba;s/\n/ /g' "${Site4}_${h2}_list.txt")


${Site1}_${h1}name=$(tr ',' ' ' < "${Site1}_${h1}_list_transpose.csv")
${Site1}_${h2}name=$(tr ',' ' ' < "${Site1}_${h2}_list_transpose.csv")

${Site2}_${h1}name=$(tr ',' ' ' < "${Site2}_${h1}_list_transpose.csv")
${Site2}_${h2}name=$(tr ',' ' ' < "${Site2}_${h2}_list_transpose.csv")

${Site3}_${h1}name=$(tr ',' ' ' < "${Site3}_${h1}_list_transpose.csv")
${Site3}_${h2}name=$(tr ',' ' ' < "${Site3}_${h2}_list_transpose.csv")

${Site4}_${h1}name=$(tr ',' ' ' < "${Site4}_${h1}_list_transpose.csv")
${Site4}_${h2}name=$(tr ',' ' ' < "${Site4}_${h2}_list_transpose.csv")

bedtools unionbedg -header -names ${Site1}_${h1}name ${Site1}_${h2}name -filler $NA -i ${Site1}_${h1}files ${Site1}_${h2}files | cut -f1,3- | sed 's/end/pos/' > "$Site1_$in_metilene"
bedtools unionbedg -header -names ${Site2}_${h1}name ${Site2}_${h2}name -filler $NA -i ${Site2}_${h1}files ${Site2}_${h2}files | cut -f1,3- | sed 's/end/pos/' > "$Site2_$in_metilene"
bedtools unionbedg -header -names ${Site3}_${h1}name ${Site3}_${h2}name -filler $NA -i ${Site3}_${h1}files ${Site3}_${h2}files | cut -f1,3- | sed 's/end/pos/' > "$Site3_$in_metilene"
bedtools unionbedg -header -names ${Site4}_${h1}name ${Site4}_${h2}name -filler $NA -i ${Site4}_${h1}files ${Site4}_${h2}files | cut -f1,3- | sed 's/end/pos/' > "$Site4_$in_metilene"

# takes awhile ~ 30 min per site - already done

#------------------------------
#header get rid of enter in first line

#header should be:
#chrom pos ${Wname} ${Cname}
# but the Cnames are one new line
W_ALAS0W_8_265
	C_ALAS_00C_227

#edit to remove extra enter
nano "$Site1_$in_metilene"
nano "$Site2_$in_metilene"
nano "$Site3_$in_metilene"
nano "$Site4_$in_metilene"

#-----------------------------
# check header
head -5 "$Site1_$in_metilene" > subset1.txt
head -5 "$Site2_$in_metilene" > subset2.txt
head -5 "$Site3_$in_metilene" > subset3.txt
head -5 "$Site4_$in_metilene" > subset4.txt

grep '^c.*' subset1.txt | wc -w
grep '^c.*' subset2.txt | wc -w
grep '^c.*' subset3.txt | wc -w
grep '^c.*' subset4.txt | wc -w
Alex -52
SV -14
LAT -22
ALAS -22

# grep '^Do.*' "$Site1_$in_metilene" | wc -l # too long
Alex - 8506281
SV - 8088914
LAT - 8318294
ALAS - 8315924

nano "$Site1_$in_metilene"
nano "$Site2_$in_metilene"
nano "$Site3_$in_metilene"
nano "$Site4_$in_metilene"
# delete enter on second line if still there



########################################################################
########################################################################




































































#############################################
# July 2022 Notes
# check space

#quota

                             Description                Space           # of files
                    /home (user celphin)              12G/50G            145k/500k
                 /scratch (user celphin)            3494G/20T            40k/1000k
                /project (group celphin)            31k/2048k               1/1025
             /project (group def-henryg)            6527G/10T            256k/500k
        /project (group rrg-rieseber-ac)          6177G/2048k            552k/1025
              /project (group def-cronk)            1265G/10T             33k/500k
           /project (group def-rieseber)            7407G/10T            367k/500k
           /project (group rpp-rieseber)            198T/200T            422k/500k
--
On some clusters, a break down per user may be available by adding the option '--per_user'.

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs

# replace
/scratch/celphin/Dryas/Nov2020_Metilene_DMR/
# with
/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/

##########################################
# copy metilene program and make

tar -xvzf metilene_v02-8.tar.gz

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/

make

###################################
# copy bedGraph files over
cd /scratch/celphin/Dryas/Nov2020_Metilene_DMR/data/
mkdir /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/
cp -v C*.bedGraph /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/
cp -v W*.bedGraph /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/

# upzip all the bedgraph files
# gunzip -v /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/*.gz

######################################
tmux new-session -s DMR
tmux attach-session -t DMR

salloc -c1 --time 3:00:00 --mem 120000m --account def-rieseber

module load StdEnv/2020
module load bedtools/2.30.0 

# make sorted bedgraph files
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/

#find . -name "*.bedGraph" -print > file_list.txt

while read name
do
bedtools sort -i ${name} >  ${name}_sorted.bedGraph
sort -c -k1,1 -k2,2n ${name}_sorted.bedGraph
cat ${name}_sorted.bedGraph | tr ' ' '\t' > ${name}_sorted_tab.bedGraph
done < file_list.txt

#-------------------------------
#get list of files
find . -name "W*_sorted_tab.bedGraph" -print > W_list.txt
find . -name "C*_sorted_tab.bedGraph" -print > C_list.txt

# replace ./ in file names
sed -i 's/\.\///g' W_list.txt
sed -i 's/\.\///g' C_list.txt

# make csv and space delimited files
tr '\t' ',' < "./W_list.txt" > "./W_list_csv.csv"
tr '\t' ',' < "./C_list.txt" > "./C_list_csv.csv"

tr '\t' ' ' < "./W_list.txt" > "./W_list_sp_.txt"
tr '\t' ' ' < "./C_list.txt" > "./C_list_sp_.txt"

# NOTE: one short in Warming list

#---------------------------
#make bed file

tmux new-session -s DMR
tmux attach-session -t DMR

salloc -c1 --time 3:00:00 --mem 120000m --account def-rieseber

module load StdEnv/2020
module load bedtools/2.30.0 

# make sorted bedgraph files
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/

NA="NA"
h1='W'
h2='C'
in_metilene="metilene_"$h1"_"$h2".input"

Wfiles=$(sed ':a;N;$!ba;s/\n/ /g' W_list.txt)
Cfiles=$(sed ':a;N;$!ba;s/\n/ /g' C_list.txt)

Wname=$(tr ',' ' ' < "./W_list_csv.csv")
Cname=$(tr ',' ' ' < "./C_list_csv.csv")

bedtools unionbedg -header -names $Wname $Cname -filler $NA -i $Wfiles $Cfiles | cut -f1,3- | sed 's/end/pos/' > $in_metilene


############################
head -5 metilene_W_C.input > subset.txt

grep '^c.*' subset.txt | wc -w
grep '^Q.*' subset.txt | wc -w
grep '^Q.*' subset.txt | wc -l

#103 values per line

#header should be:
#chrom pos ${Wname} ${Cname}
# but the Cnames are one new line
W_ALAS0W_8_265
	C_ALAS_00C_227

#edit to remove extra enter
nano metilene_W_C.input

# check header again
head -5 metilene_W_C.input > subset2.txt

grep '^c.*' subset2.txt | wc -w
103
grep '^Q.*' subset2.txt | wc -w
412
grep '^Q.*' subset2.txt | wc -l
4
-------------------------------
salloc -c10 --time 3:00:00 --mem 120000m --account def-rieseber

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/

module load StdEnv/2020
module load bedtools/2.30.0 

/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_W_C.input --maxdist 100 --mincpgs 20 --minMethDiff 0.2 --mode 1 --threads 10 -a W -b C -v 0.2 > metilene_output_June2022_maxd100_minC20_mindiff20.txt

segmenting Do1_a00047-[146885,147093], 16 CpGs
segmenting Do1_a00047-[147217,148270], 103 CpGs
segmenting Do1_a00047-[148449,148480], 3 CpGs
Number of Tests: 849862


# maxdist (allowed nt distance between two CpGs within a DMR)
# mincpgs (minimum # of CpGs in a DMR)
# minMethDiff (minimum mean methylation difference for calling DMRs)

# should try default values
/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_W_C.input --mode 1 --threads 10 -a W -b C > metilene_output_June2022_default.txt


Number of Tests: 899946

# header of output
chr	start	end	q-value	mean_methyl	#CpGs	p-value_MWU	p-value_2D-KS	mean_g1	mean_g2

#####################################
# want to elect only low p-values?
#perl filterOutput.pl -q <string>[-o <string>] [-p <n>] [-c <n>] [-d <n>] [-l <n>] [-a <string>] [-b <string>]

#q-value is the Bonferroni adjusted p-value

# need R installed with ggplot2

module load nixpkgs/16.09
module load gcc/7.3.0
module load r/3.6.0
module load gdal
module load udunits
module load python
export R_LIBS_USER=/home/celphin/R/x86_64-pc-linux-gnu-library/3.6/

perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_output_June2022_default.txt -p 0.001

[INFO]  Mon Jun 20, 19:37:43, 2022      Checking flags
[INFO]  Mon Jun 20, 19:37:43, 2022      Filter DMRs.
[INFO]  Mon Jun 20, 19:37:44, 2022      Wrote 638 DMRs with adj. p-value<0.001, a minimum absolute difference>=0.1, a minimum length [CpG]>=10 and a minimum length [nt]>=0
[INFO]  Mon Jun 20, 19:37:44, 2022      Bedgraph file containing DMR difference: /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_${minmeandiff}_qval.0.001.bedgraph
[INFO]  Mon Jun 20, 19:37:44, 2022      Plot DMR statistics.
Warning messages:
1: Removed 630 rows containing non-finite values (stat_bin).
2: Removed 2 rows containing missing values (geom_bar).
null device
          1

#####################################
#make into loop to run through list of DMRs and make into bedGraph

#test
chrom=QANW01012871.1	
start=644636
end=645586

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/

grep "^${chrom}" metilene_W_C.input | awk '^"${chrom}"[ \t].*[ \t]' "${start}<=$1 && $1>=${end}" {print} > "${chrom}_${start}_${end}.txt"

#https://www.geeksforgeeks.org/awk-command-unixlinux-examples/
#awk

grep "^${chrom}" metilene_W_C.input | awk '${start}<=$1 && $1>=${end} > 2 {print $0}' > "${chrom}_${start}_${end}.txt"


############################################
#old Dec 2020 DMR results
chr	         start	end	q-value	        meanmethyl	CpG	meanW	meanC    Percent
*Ak QANW01001165.1	34598	35359	0.0056529	2.899366	104	3.065	0.16565	0.945959543 cyclin-dependent protein kinase inhibitor SMR4 - Alaska only
*Ak QANW01004277.1	644636	645586	3.26E-18	4.838051	114	5.1676	0.32958	0.936227843 putative chromatin regulator PHD family - https://www.uniprot.org/uniprot/A0A072TQ60 - Alaska only
NA QANW01002342.1	298671	298912	0.024042	10.633866	13	12.095	1.4614	0.879195205 TMV resistance protein N, elongator complex protein 4 - none other than total - probably fake
*Ak QANW01008327.1	543268	543873	0.023383	5.277628	49	6.4392	1.1616	0.819609268 pentatricopeptide repeat-containing protein At5g48910 - Alaska only
*Sw QANW01002303.1	215969	216301	0.0010245	5.694042	42	7.3993	1.7052	0.769537929 galactolipase DONGLE, chloroplastic - Sweden only
*Sw QANW01008096.1	333154	333396	0.046508	10.00304	15	13.484	3.481	0.74184515 putative disease resistance RPP13
**Sv/Sw QANW01009682.1	1662061	1662274	3.77E-05	6.55536	        14	9.008	2.4526	0.727726465 chloroplast related pseudomolecule
*AF QANW01012871.1	2591349	2591541	0.027029	8.038265	18	11.445	3.407	0.702338576 K(+) efflux antiporter 5 -Up-regulated by osmotic stress -  https://www.uniprot.org/uniprot/Q8VYR9
*AF QANW01002384.1	329	1788	3.68E-51	3.631189	120	5.8418	2.2106   mitochondrion genome, cytochrome c oxidase subunit 3, ATP synthase subunit a
***Sw,A,A QANW01009069.1	972927	973718	9.82E-50	8.268598	76	27.016	18.747  could not find exact but 955684-957433 A-genome sucrose synthase SusA1
** A,A QANW01001771.1	3355408	3356600	3.43E-42	12.50787	50	73.021	60.513  TMV resistance protein N - not in Sweden and Svalbard
**Sw/AF QANW01009069.1	1003118	1004558	2.95E-38	-17.019465	69	30.346	47.366  could not find see above
**Sw,AK QANW01006396.1	18396	20173	4.48E-38	-10.368359	87	26.352	36.72   NUCLEAR FUSION DEFECTIVE 4 , microsatellite sequence , pentatricopeptide repeat-containing protein At5g27110 https://ppr.plantenergy.uwa.edu.au/
***Sw,A,A QANW01009069.1	364471	364974	1.23E-36	16.588691	58	39.662	23.073 could not find for exact but 361760-363509 is a transcription factor, transcription factor bHLH128 https://www.uniprot.org/uniprot/Q8H102.html
***Sw,A,A QANW01009069.1	364053	364462	7.19E-36	17.741908	49	45.558	27.816 could not find see above
**A,A QANW01001876.1	1016243	1016970	2.20E-34	10.093475	72	66.654	56.561  TilSSR_18905 microsatellite
**AF,Sw QANW01009334.1	910318	911316	1.40E-31	6.608318	166	30.858	24.25   uncharacterized, ORF-1 in a tandem repeat (ORF=open reading frame), open reading frame maps to senescence leaf regulator 
***Sw,A,A QANW01009069.1	972719	972858	3.52E-31	15.537374	34	29.917	14.38  could not find see above
***Sw,A,A QANW01004277.1	751202	751791	6.60E-31	13.671452	82	39.089	25.417 polygalacturonase At1g48100 - cell wall expression
***A,A,Sw QANW01003660.1	100234	101048	1.07E-29	6.306462	72	42.946	36.639 universal stress protein PHOS32 https://www.uniprot.org/uniprot/Q8VYN9 https://www.frontiersin.org/articles/10.3389/fpls.2019.00750/full - all but Svalbard
*Sw QANW01012686.1	147090	148250	3.55E-28	-7.449562	85	22.231	29.681
**A,A QANW01000494.1	427026	427981	3.31E-27	-4.726499	68	8.9658	13.692 3-Hydroxyisobutyrate Dehydrogenase - amino acid catabolism in the dark or stress -  https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5580760/
****QANW01004202.1	170500	170654	2.39E-25	19.302325	26	70.968	51.666 amidase At4g34880 -related to nitrogen fixation with bacteria - Rose   NC_037093 REGION: 646156..650321, mRNA from 391-462 maps to Rose mRNA, DMR is 154 base pairs past this exactly matching where first exon ends - where methylation starts is where mapping stops to Rose but the base pair range is still correct to perfectly match the exon length - more nitrogen allows for leaf growth -  makes auxin https://europepmc.org/article/med/23844031 - https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4844348/
*AF QANW01008704.1	433897	434367	1.12E-24	-15.71436	59	47.2	62.915
*Sw QANW01010875.1	2206907	2207516	1.37E-24	-10.642345	52	32.101	42.743 pentatricopeptide repeat-containing protein At1g79490, mitochondrial https://www.uniprot.org/uniprot/Q9SAK0 https://ppr.plantenergy.uwa.edu.au/
*Sw QANW01005326.1	1650781	1651338	8.62E-24	-6.832467	108	9.728	16.56   LRR receptor-like serine/threonine-protein kinase GSO1 - Repressed by wounding -  https://www.uniprot.org/uniprot/C0LGQ5
*Sw,AK QANW01013335.1	378322	378988	1.22E-23	-6.418297	58	4.1588	10.577
*Ak QANW01001850.1	116944	117186	1.22E-23	-4.527219	40	4.0742	8.6015  
***Sw,AK,AF QANW01008701.1	793587	793886	1.92E-23	14.870605	40	32.069	17.199  natterin 3-like protein mRNA, partial cds 
*Ak QANW01004277.1	644636	645586	3.26E-18	4.838051	114	5.1676	0.32958
*Sw,Ak QANW01002312.1	109062	109423	4.55E-15	18.131615	24	69.684	51.553 serine/threonine-protein kinase At5g01020
*Ak QANW01001165.1	34598	35359	0.0056529	2.899366	104	3.065	0.16565 cyclin-dependent protein kinase inhibitor - stops cell cycle - https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5351735/
**Ak,Sv QANW01007298.1	176455	177430	3.6506e-31	28.762947	141	28.977	0.21411  tRNA:m(4)X modification enzyme TRM13 https://www.uniprot.org/uniprot/Q10B19 - plant silencing TRM13 display decreased stress tolerance - warming plants silence this? - Induced by salt stress and abscisic acid treatment. https://en.wikipedia.org/wiki/Abscisic_acid
*Sv QANW01009150.1	254308	254728	3.5885e-13	18.498824	45	18.696	0.19749

############################################
# Papers

https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4728377/
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4588864/ 

####################################### 
# try for each site

# July 8th 2022

# make W_list_transpose.csv by transposing W_list.txt in Excel and saving as a csv

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/

Site="SVAL"
Site="LAT"
Site="ALAS"

grep ".*${Site}.*" W_list.txt > "${Site}_W_list.txt"
grep ".*${Site}.*" C_list.txt > "${Site}_C_list.txt"

#grep ".*${Site}.*" W_list_transpose.csv > "${Site}_W_list_transpose.csv"
#grep ".*${Site}.*" C_list_transpose.csv > "${Site}_C_list_transpose.csv"
# currently this tranpose file is not used for anything... just repeat with the site specific files

#--------------------------
#for Alex

Site="Alex"

grep -E "CASS"\|"DRY"\|"MEAD"\|"WILL"\|"FERT" W_list.txt > "Alex_W_list.txt"
grep -E "CASS"\|"DRY"\|"MEAD"\|"WILL"\|"FERT" C_list.txt > "Alex_C_list.txt"

#grep -E "CASS"\|"DRY"\|"MEAD"\|"WILL"\|"FERT" W_list_transpose.csv > "Alex_W_list_transpose.csv"
#grep -E "CASS"\|"DRY"\|"MEAD"\|"WILL"\|"FERT" C_list_transpose.csv > "Alex_C_list_transpose.csv"

#--------------------

Wfiles=$(sed ':a;N;$!ba;s/\n/ /g' "${Site}_W_list.txt")
Cfiles=$(sed ':a;N;$!ba;s/\n/ /g' "${Site}_C_list.txt")

#-----------------------------
# need to format names here for each location
# download and edit in Excel: {Site}_W/C_list.txt
# files here: /~/Cassandra/PhD/GenomeBC_Dryas/Wild_Dryas_WGBS/June2022_DMRs/File_names/Site_specific/
# - edit to clean names
	- =MID(A1,FIND("_",A1)+1,256)
	- =RIGHT(A1,(FIND(" ",B1,1)-1))
	- Add W to the front = CONCATENATE("X",C1) 
# retranspose into a row?
# save as csv

Wname=$(tr ',' ' ' < "${Site}_W_list_transpose.csv")
Cname=$(tr ',' ' ' < "${Site}_C_list_transpose.csv")

#--------------------------
tmux new-session -s DMR 
tmux attach-session -t DMR

tmux new-session -s DMR2
tmux attach-session -t DMR2

salloc -c10 --time 3:00:00 --mem 120000m --account def-rieseber

module load nixpkgs/16.09
module load intel/2018.3
module load bedtools/2.29.2

# make sorted bedgraph files
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/

NA="NA"
h1='W'
h2='C'

Site="Alex" # DMR
Site="SVAL" # DMR2
Site="LAT"  # DMR3
Site="ALAS"  # DMR4

in_metilene=""${Site}"_metilene_"$h1"_"$h2".input"

Wfiles=$(sed ':a;N;$!ba;s/\n/ /g' "${Site}_W_list.txt")
Cfiles=$(sed ':a;N;$!ba;s/\n/ /g' "${Site}_C_list.txt")

Wname=$(tr ',' ' ' < "${Site}_W_list_transpose.csv")
Cname=$(tr ',' ' ' < "${Site}_C_list_transpose.csv")


bedtools unionbedg -header -names $Wname $Cname -filler $NA -i $Wfiles $Cfiles | cut -f1,3- | sed 's/end/pos/' > $in_metilene

# takes awhile ~ 30 min

#------------------------------
#header get rid of enter in first line

#header should be:
#chrom pos ${Wname} ${Cname}
# but the Cnames are one new line
W_ALAS0W_8_265
	C_ALAS_00C_227

#edit to remove extra enter
nano $in_metilene

#-----------------------------
# check header
head -5 $in_metilene > subset.txt

grep '^c.*' subset.txt | wc -w
Alex -52
SV -14
LAT -22
ALAS -22

# grep '^Do.*' $in_metilene | wc -l # too long
Alex - 8506281
SV - 8088914
LAT - 8318294
ALAS - 8315924

#-----------------
#run metilene

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/

module load nixpkgs/16.09
module load intel/2018.3
module load bedtools/2.29.2

Site="Alex"
#Site="SVAL"
#Site="LAT"
#Site="ALAS"
NA="NA"
h1='W'
h2='C'
in_metilene=""${Site}"_metilene_"$h1"_"$h2".input"

#-------------------
nano $in_metilene
# delete enter on second line

head $in_metilene

/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/${in_metilene} --mode 1 --threads 10 -a W -b C > ""$Site"_metilene_output_July2022.txt"
/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/${in_metilene} --maxdist 100 --mincpgs 30 --minMethDiff 5 --mode 1 --threads 10 -a W -b C > ""$Site"_metilene_output_July2022_100-30-5.txt"
/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/${in_metilene} --maxdist 300 --mincpgs 30 --minMethDiff 15 --mode 1 --threads 10 -a W -b C > ""$Site"_metilene_output_July2022_300-30-15.txt"
/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/${in_metilene} --maxdist 300 --mincpgs 500 --minMethDiff 200 --mode 1 --threads 10 -a W -b C > ""$Site"_metilene_output_July2022_300-500-200.txt"
/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/${in_metilene} --maxdist 100 --mincpgs 10 --minMethDiff 10 --mode 1 --threads 10 -a W -b C > ""$Site"_metilene_output_July2022_100-10-10.txt"

*******************************
#------------------------------
#subset significant DMRs

module load nixpkgs/16.09
module load gcc/7.3.0
module load r/3.6.0
module load gdal
module load udunits
module load python
export R_LIBS_USER=/home/celphin/R/x86_64-pc-linux-gnu-library/3.6/

perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs" -p 0.05
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022_100-30-5.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs_100-30-5" -p 0.05
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022_300-30-15.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs_300-30-15" -p 0.05
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022_300-500-200.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs_300-500-200" -p 0.05
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022_100-10-10.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs_100-10-10" -p 0.05

perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs" -p 1e-10
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022_100-30-5.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs_100-30-5" -p 1e-10
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022_300-30-15.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs_300-30-15" -p 1e-10
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022_300-500-200.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs_300-500-200" -p 1e-10
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/"$Site"_metilene_output_July2022_100-10-10.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs_100-10-10" -p 1e-10

grep '^Do.*' "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/"$Site"_DMRs_100-10-10_qval.1e-10.bedgraph" | wc -l 
Sval - 80
LAT - 603
ALAS - 261
Alex - 59

#########################################
#run for total file

tmux new-session -s DMR5
tmux attach-session -t DMR5

salloc -c10 --time 3:00:00 --mem 120000m --account def-rieseber

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/

module load nixpkgs/16.09
module load intel/2018.3
module load bedtools/2.29.2

/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_W_C.input --maxdist 300 --mincpgs 15 --minMethDiff 10 --mode 1 --threads 10 -a W -b C > "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_output_July2022_300-15-10.txt"
/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_W_C.input --maxdist 100 --mincpgs 10 --minMethDiff 10 --mode 1 --threads 10 -a W -b C > "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_output_July2022_100-10-10.txt"
/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_W_C.input --maxdist 300 --mincpgs 500 --minMethDiff 200 --mode 1 --threads 10 -a W -b C > "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_output_July2022_300-500-200.txt"
*/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_W_C.input --maxdist 300 --mincpgs 50 --minMethDiff 15 --mode 1 --threads 10 -a W -b C > "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_output_July2022_300-50-15.txt"

#---------------------
module load nixpkgs/16.09
module load gcc/7.3.0
module load r/3.6.0
module load gdal
module load udunits
module load python
export R_LIBS_USER=/home/celphin/R/x86_64-pc-linux-gnu-library/3.6/

perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_output_July2022_300-15-10.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/Total_DMRs_300-15-10_July2022" -p 1e-20
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_output_July2022_100-10-10.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/Total_DMRs_100-10-10_July2022" -p 1e-20
perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_output_July2022_300-500-200.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/Total_DMRs_300-500-200_July2022" -p 1e-20
*perl /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/metilene_v0.2-8/metilene_output.pl -q "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/data/metilene_output_July2022_300-50-15.txt" -o "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/Total_DMRs_300-50-15_July2022" -p 1e-20

grep '^Do.*' "/home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/Total_DMRs_100-10-10_July2022_qval.1e-20.bedgraph" | wc -l 

more /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/Total_DMRs_100-10-10_July2022_qval.1e-20.out

# new

Do1_01_a00004   4252688 	4253212 	1.1308e-25      -10.952967      60      58.017  68.97
Do1_03_a00002   5353037 	5354212 	9.546e-42       -11.299114      126     29.726  41.025
Do1_03_a00002   12037975        12038326        1.962e-26       -19.057195      31      30.102  49.16
Do1_03_a00002   12806950        12807303        5.104e-21       -15.823461      20      25.756  41.579
Do1_03_a00004   1829129 	1829473 	1.5031e-30      -13.568443      57      12.72   26.289
Do1_05_a00001   17164475        17164996        5.7885e-32      -10.250966      87      69.97   80.221
Do1_05_a00003   1152846 	1152987 	1.0569e-25      16.729108       24      63.045  46.316 Amidase?
Do1_05_a00003   1480241 	1480901 	3.4393e-31      -17.662892      56      29.687  47.35
Do1_05_a00004   324260  	324804  	1.089e-28       15.288720       44      47.188  31.899
Do1_06_a00002   2718020 	2718459 	5.9126e-27      13.149616       80      38.86   25.71 - POLYGALACTURONASE INVOLVED IN EXPANSION3 - AT1G48100.1
Do1_07_a00002   11005173        11005813        1.2637e-32      16.242843       72      74.506  58.263
Do1_07_a00002   12442551        12443127        2.6466e-78      -16.334069      90      57.642  73.976
Do1_07_a00004   2484955 	2485400 	3.4851e-36      -14.654374      50      44.5    59.155
Do1_a00028      195651  	195795  	2.3956e-24      20.380830       24      48.109  27.728

Do1_05_a00004:323760-325304 - syntaxin-71 
Do1_06_a00002:2717520-2718959 - POLYGALACTURONASE INVOLVED IN EXPANSION3 - AT1G48100.1
Do1_07_a00002:12442051-12443627 - NADH dehydrogenase subunit 4 gene, complete cds; mitochondrial


#old
QANW01001771.1	3355408	3356344	9.3589e-40	12.520851	48	72.877	60.356
QANW01001876.1	1016389	1016639	4.3804e-28	10.042394	52	66.547	56.505
****QANW01004202.1	170500	170654	2.7592e-25	19.302325	26	70.968	51.666  Amidase https://europepmc.org/article/med/23844031
QANW01004277.1	751202	751641	1.3934e-30	13.760080	80	39.7	25.94   polygalacturonase At1g48100, cell wall, only clear methylation at Alex
QANW01006396.1	18396	19197	2.8413e-29	-10.458315	58	21.374	31.832 pentatricopeptide repeat-containing protein At5g27110, RNA modification, methylated in controls
QANW01008701.1	793218	793578	3.5523e-23	11.087057	50	28.246	17.159 natterin-3 - found in frog toxins?
QANW01008701.1	793587	793886	2.2072e-23	14.870605	40	32.069	17.199
QANW01008704.1	433897	434247	1.2568e-23	-15.704527	58	47.25	62.954
**QANW01009069.1	364053	364462	8.286e-36	17.741908	49	45.558	27.816
QANW01009069.1	364570	364789	1.8671e-25	18.058379	41	40.775	22.716
QANW01009069.1	1004041	1004558	1.5669e-26	-17.268493	49	30.636	47.904
QANW01009069.1	972719	972858	4.0593e-31	15.537374	34	29.917	14.38
QANW01010875.1	2206907	2207393	4.4125e-23	-10.696057	50	32.065	42.761


#######################################
#need to find a way to get only the values that fall in the same general range +-1000bp 
# https://bedtools.readthedocs.io/en/latest/content/tools/intersect.html

module load nixpkgs/16.09  
module load gcc/7.3.0
module load bedtools/2.29.2

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/

# All sites intersect
bedtools intersect -u -a Total_DMRs_100-10-10_July2022_qval.1e-20.bedgraph -b SVAL_DMRs_100-10-10_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b Alex_DMRs_100-10-10_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b ALAS_DMRs_100-10-10_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_100-10-10_qval.0.05.bedgraph > ALL_Sites_intersect_DMRs_100-10-10_qval.0.05.bedgraph
bedtools intersect -u -a Total_DMRs_100-10-10_July2022_qval.1e-20.bedgraph -b SVAL_DMRs_100-10-10_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b Alex_DMRs_100-10-10_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b ALAS_DMRs_100-10-10_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_100-10-10_qval.0.05.bedgraph > ALL_Sites_intersect_DMRs_100-10-10_qval.0.05.txt
# new
Do1_07_a00002   12442551        12443127        -16.334069

bedtools intersect -u -a Total_DMRs_300-15-10_July2022_qval.1e-20.bedgraph -b SVAL_DMRs_300-30-15_qval.1e-10.bedgraph | bedtools intersect -u -a stdin -b Alex_DMRs_300-30-15_qval.1e-10.bedgraph | bedtools intersect -u -a stdin -b ALAS_DMRs_300-30-15_qval.1e-10.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_100-10-10_qval.0.05.bedgraph > ALL_Sites_intersect_DMRs_300-30-15_qval.1e-10.bedgraph
bedtools intersect -u -a Total_DMRs_300-15-10_July2022_qval.1e-20.bedgraph -b SVAL_DMRs_300-30-15_qval.1e-10.bedgraph | bedtools intersect -u -a stdin -b Alex_DMRs_300-30-15_qval.1e-10.bedgraph | bedtools intersect -u -a stdin -b ALAS_DMRs_300-30-15_qval.1e-10.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_100-10-10_qval.0.05.bedgraph > ALL_Sites_intersect_DMRs_300-30-15_qval.1e-10.txt
# new
Do1_07_a00002   12442551        12443127        -16.334069

# All sites intersect
bedtools intersect -u -a Alex_DMRs_qval.0.05.bedgraph -b SVAL_DMRs_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b ALAS_DMRs_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_qval.0.05.bedgraph > ALL_Sites_intersect_DMRs_qval.0.05.bedgraph
bedtools intersect -u -a Alex_DMRs_qval.0.05.bedgraph -b SVAL_DMRs_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b ALAS_DMRs_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_qval.0.05.bedgraph > ALL_Sites_intersect_DMRs_qval.0.05.txt
# new
Do1_01_a00004   10489852        10490314        -9.776923
Do1_02_a00003   5845511 	5845794 	4.649067
Do1_04_a00001   348437  	348594  	-3.712961
Do1_04_a00001   18196491        18199661        -9.329603
Do1_07_a00002   11718437        11718722        -12.338015
Do1_07_a00002   12442599        12443071        -16.864050
Do1_07_a00004   6444548 	6444686 	8.981807
Do1_07_a00004   6444686 	6444873 	4.765740

# old
QANW01004202.1	170500	170654	19.302325

#---------------------
# All sites intersect but SVAL
bedtools intersect -u -a Alex_DMRs_qval.0.05.bedgraph -b ALAS_DMRs_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_qval.0.05.bedgraph > ALL_Sites_notSVAL_intersect_DMRs_qval.0.05.bedgraph
bedtools intersect -u -a Alex_DMRs_qval.0.05.bedgraph -b ALAS_DMRs_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_qval.0.05.bedgraph > ALL_Sites_notSVAL_intersect_DMRs_qval.0.05.txt

#new
Do1_01_a00001   12561356        12562161        -14.373344
Do1_01_a00001   14998115        14998713        -5.342084
Do1_01_a00004   9410118 9410345 13.326797
Do1_01_a00004   10489852        10490314        -9.776923
Do1_02_a00003   4668909 4668977 -13.138881
Do1_02_a00003   5845511 5845794 4.649067
Do1_02_a00004   2614923 2615910 12.935337
Do1_02_a00004   2870503 2871054 -9.188182
Do1_03_a00002   429039  429695  5.228883
Do1_03_a00002   5374897 5375857 11.132014
Do1_03_a00004   1829074 1829472 -11.157563
Do1_04_a00001   348437  348594  -3.712961
Do1_04_a00001   11637435        11638165        18.786320
Do1_04_a00001   16669574        16670171        -12.125714
Do1_04_a00001   18205838        18206171        8.351663
Do1_04_a00001   18196491        18199661        -9.329603
Do1_05_a00001   3771359 3771544 -2.972906
Do1_05_a00001   6650073 6650955 9.211859
Do1_05_a00001   17164316        17164938        -10.679501
Do1_05_a00002   135131  135804  -11.523540
Do1_05_a00002   2523208 2523547 22.113804
Do1_05_a00003   1480721 1481089 -21.000175 Amidase related in Alex?
Do1_06_a00002   2234705 2236035 11.861889
Do1_06_a00002   2575966 2576071 -6.210634
Do1_06_a00002   2576147 2576551 -7.538098
Do1_06_a00002   2718020 2718273 15.256977
Do1_06_a00002   2718287 2718459 15.545067
Do1_07_a00002   11718437        11718722        -12.338015
Do1_07_a00002   12442599        12443071        -16.864050
Do1_07_a00002   13411252        13411534        7.798404
Do1_07_a00004   2484955 2485598 -14.721486
Do1_07_a00004   5844581 5844983 14.448108
Do1_07_a00004   6444548 6444686 8.981807
Do1_07_a00004   6444686 6444873 4.765740
Do1_a00028      195161  195505  10.833325
Do1_a00028      195529  195806  15.253211
Do1_a00045      703690  704660  -10.066610
Do1_a00045      1676794 1677049 14.302978


#old
QANW01001271.1	21175	21709	-9.464021
QANW01001424.1	565374	565928	5.660922
QANW01003660.1	100234	101048	6.306462 Universal stress protein
QANW01003660.1	101058	101208	9.937087
QANW01004202.1	170500	170654	19.302325 Amidase
QANW01004277.1	878748	879274	-4.887961 importin alpha isoform4 maps to first exon, related to powdery mildew and senescnce 
QANW01004277.1	879332	879442	-2.055605
QANW01004277.1	879442	879517	-3.176011
QANW01004277.1	751202	751791	13.671452 maps to last exon of polygalacturanse, glycoside hydrolase in Arabidopsis for cell growth dehydration stress affects this gene
QANW01004346.1	9	326	6.421627
QANW01004346.1	342	483	8.850667
QANW01006695.1	52673	53571	-12.512968
QANW01008701.1	793218	793578	11.087057
QANW01008701.1	793587	793886	14.870605
QANW01009069.1	364053	364462	17.741908
QANW01009069.1	364471	364974	16.588691
QANW01009069.1	972719	972858	15.537374
QANW01009069.1	972927	973718	8.268598

#------------------------
# all but Alex
bedtools intersect -u -a ALAS_DMRs_qval.0.05.bedgraph -b SVAL_DMRs_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_qval.0.05.bedgraph > ALL_Sites_notAlex_intersect_DMRs_qval.0.05.bedgraph
bedtools intersect -u -a ALAS_DMRs_qval.0.05.bedgraph -b SVAL_DMRs_qval.0.05.bedgraph | bedtools intersect -u -a stdin -b LAT_DMRs_qval.0.05.bedgraph > ALL_Sites_notAlex_intersect_DMRs_qval.0.05.txt

#new
Do1_00165       45010   45447   20.614259
Do1_00210       22703   22872   1.334687
Do1_01_a00001   74683   75505   -14.924635
Do1_01_a00002   25100   25334   -23.438780
Do1_01_a00002   25378   25871   -14.480702
Do1_01_a00006   57708   58064   -15.056224
Do1_02_a00001   974463  974572  -14.761781
Do1_02_a00001   10953440        10954298        -10.839506
Do1_02_a00003   5845511 5845794 13.437387
Do1_02_a00003   8431538 8432990 19.161441
Do1_02_a00003   8851851 8852027 32.439734
Do1_03_a00001   6406868 6407443 -22.017375
Do1_03_a00002   4879264 4879696 -15.440511
Do1_03_a00003   2105487 2105948 -12.854765
Do1_04_a00001   348499  348580  -5.731093
Do1_04_a00001   13954876        13955023        -5.282578
Do1_04_a00003   1930200 1932304 15.378439
Do1_04_a00004   890470  891108  -13.377238
Do1_05_a00003   1152846 1152986 27.562313 Amidase
Do1_06_a00001   3045790 3046891 22.317409
Do1_06_a00001   13468989        13469131        7.452173
Do1_06_a00002   2073588 2073689 -18.683279
Do1_06_a00002   7338536 7339360 20.021544
Do1_07_a00001   3265590 3266056 -16.177699
Do1_07_a00002   396850  397137  -19.528926
Do1_07_a00002   11006078        11006820        -19.579109
Do1_07_a00002   11718523        11718688        -24.994242
Do1_07_a00002   12442455        12443488        -39.265793
Do1_07_a00004   2914703 2915405 -7.662282
Do1_07_a00004   6444512 6444873 14.225788


#old
QANW01003600.1	112444	113078	5.935392
QANW01004202.1	170500	170654	19.302325
QANW01009953.1	1036361	1036628	-7.104241
QANW01010754.1	458436	458958	9.993508
QANW01012165.1	847716	847993	17.556858


###############################################
###############################################
# convert bedGraph files to bed files to fasta files

cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/
cat Total_DMRs_100-10-10_July2022_qval.1e-20.bedgraph | awk '{print $1 "\t" $2 "\t" $3}' > Total_DMRs_100-10-10_July2022_qval.1e-20.bed

#----------------------------
# add 500bp on each side of the DMR
***************
awk '{$3+=1000}1' Total_DMRs_100-10-10_July2022_qval.1e-20.bed > Total_DMRs_100-10-10_July2022_qval.1e-20_extended.bed
awk '{$2-=1000}1' Total_DMRs_100-10-10_July2022_qval.1e-20_extended.bed > Total_DMRs_100-10-10_July2022_qval.1e-20_extended2.bed

Do1_01_a00004 4252188 4253712
Do1_03_a00002 5352537 5354712
Do1_03_a00002 12037475 12038826
Do1_03_a00002 12806450 12807803
Do1_03_a00004 1828629 1829973
Do1_05_a00001 17163975 17165496
Do1_05_a00003 1152346 1153487
Do1_05_a00003 1479741 1481401
Do1_05_a00004 323760 325304
Do1_06_a00002 2717520 2718959
Do1_07_a00002 11004673 11006313
Do1_07_a00002 12442051 12443627
Do1_07_a00004 2484455 2485900
Do1_a00028 195151 196295

Do1_01_a00004   4251688 4254212
Do1_03_a00002   5352037 5355212
Do1_03_a00002   12036975        12039326
Do1_03_a00002   12805950        12808303
Do1_03_a00004   1828129 1830473
Do1_05_a00001   17163475        17165996
Do1_05_a00003   1151846 1153987
Do1_05_a00003   1479241 1481901
Do1_05_a00004   323260  325804
Do1_06_a00002   2717020 2719459
Do1_07_a00002   11004173        11006813
Do1_07_a00004   2483955 2486400
Do1_a00028      194651  196795



#----------------------
# https://bedtools.readthedocs.io/en/latest/content/tools/getfasta.html
# bedtools getfasta [OPTIONS] -fi <input FASTA> -bed <BED/GFF/VCF>

sed -e 's/ /\t/g' Total_DMRs_100-10-10_July2022_qval.1e-20_extended2.bed > Total_DMRs_100-10-10_July2022_qval.1e-20_extended2_tab.bed

bedtools getfasta -fi /home/celphin/scratch/Dryas/Dryas_octopetala_reference/genomes/Dryas_octopetala_H1.supercontigs.fa -bed Total_DMRs_100-10-10_July2022_qval.1e-20_extended2_tab.bed > Total_DMRs_100-10-10_July2022_qval.1e-20_extended.fasta

more Total_DMRs_100-10-10_July2022_qval.1e-20_extended.fasta

# try the only blast
>Do1_a00028:194651-196795
GTATATGATAACATCAAAATCGAAGAGGTGAAGTGTGTACCAGAGTTGAAGTTAAAGGCGAGAGGAATGCTGATCCGAGAGACCTCCGGAGCAAACCAATTCCCTGTAATAAGAATTGGACGAGTCTTCCACTCTTTACAAAATGTAGGCTTGTTC
CCAAAGAACACACAATGGTGTCGAGGCGTAATATGGTAATACCCAATCTCATTCCTGACAGTAGCACAACAATGATAAGCAAAGAAATCGATAAGTCCCAAGGAGACACCCCAACACAGGCCGAGCTCGAGAAAAGCAGAAATTGTAAGAAAACTA
TTGGGGTTTACTTGCATTGGAGACAAGCCCAAGAAGCTGAAAACCAGATGGAATACGAGGTGTAAAGGAAACCTAACATGATCAAGATGATTAAAAGACAGAACTATAGAATTCCCAGGTAATCCTGCTCCAGTTCGAATGTTAGCATCACGAGGT
AAGCCACGGAAAACTACATCATCTGGGGCTTTGCACTTTTGTCGGGCTATGGCAAGGTCTTGGTCAGTTTGGTTCCACAAAGTTGTGTTATTTTTATAATTCTTTGCCATAAAAATAAAATGCAGAAAGGCACTAACCTAAACTAAGAGAAGATAA
GAGCTAATTTGAGAAGTGCCCAAGTTCTGCTAAACATCGCCGAACCCAAGTCTACTGAACCAAGGAAACGCCGCAGACCTCGCCGAAACCCAAGTCTGCTGAACCAGGGAAATGCCGCAAACCTTGCCGAACCCAAGTCTACTGAACCAAGGAAAC
GTCGCAGACCCCATCGAAAGCCACCAGCTTCGCTGAACAGCTGAACGCACGCAGCAAGTCACACCGAACCGCCGAGCGCCCAGGCCTTACTGAACTGCCGAACCCAGCAACCTTGCTGAATCGTCGAACTGCCGAAACCAGAGTTGCTAGATCGCC
AAGACTCGCCGAACAAGAAGACTCGAATTCTCGCAGCCGAAACGGCAAGCAAGTTGCATGTTGTCGTCACCGGACCTCAACTCTGGTGAGACGCGAAGAGGGTCGCGTTACTGAAATTCAGGAAACCCAAGCCTTGACAGCGTGTTTGGAGACCAA
AGCCGACTTCGATGCCGAGAGCTACTAGCAAACTGCGAGACAAACAGATGCGATGATCGTGCGCAAGTCTGAGTGTGGTGCACAGTCGGTGGCGGCGAACGCGGCTGTGCAAGAATTCAATGGTGAGGCAGCCCAGATGAGTAATAGGGAGATATG
GCACCGAGAAGGATAAGTGGTGAAATTTTATTCAAAACATGAAAGGAGTTCGCGCAGGTGATGATGTCTTCTCCTTAAAATTGCTTTTTAATGGTTTAAAGATGTTTATTTAATTTGAAAATTGGCTAATATTTATCCGGCCCAACTAGGTATGTG
ATAAAGTCTATCATATTAATTTTATTTGAATTAGTGAAAAAATAGGAAATCCAGATGATGAAGGAAAATAATTGATTTTTCTTTAATAAAATCTATAGAGATTAAATTAAAGAAAAAGGGAGCATTATAGGGGAGATTATTTTCGTGAGCCCAAAT
TTGAAGTTTGAAGCCTAGAATATCAAACAACATTTGGGTTGAACCCATAAGAATAATTTAACTGAGTTTGGGTTTGTGAAGCTATTATGTTGAAAAGTCCAGGATGTAGTTAAGTTTATCCTCGTGACTAAATTCAATTGAAAACGTGGGCGTGAA
GTGCAAGTAACACCACGAAACATCGGAATGGAAGACGCATGGATGGAGAAACTTGCGCCTTACGTCGTAAACTTTATCCACAAGAAATTTTTGACTATATATATATATATATACATAATCATAGTCATTAGAGAAGGTACACAATCCAACCATTTG
AGCATTTATTTGCATCAGACATAAAAATAACTTGAGCGTCGGAGTATCTTTTGTGGGTACCTCACCCGCCGTACAAAAACAAACTCAAATCAAAGTCATATATATAGCGAGCGTGATCTAGAGTTCAATTCCAAAGTCAACATCAACAACCTGCAG
GCCAAGTTATCTTCTTTGAAGATTTTGGGTCCAATAGGCAGCCAGCAAATGGAGGTTCAGGGGCGCAGCAGAGCCAGTACTGAGCAGTTGGGAGAGGTTGTATCATGGTGATTTTC


>Do1_05_a00003:1151846-1153987
GTCTTTCCCACAAACGGAGCCAATTGTTGAACCCAAAATTTCTCGAAGATAAATTAAGTTAACAATAAAATTATTTGGAGCTTGAACGTTTGACGTGAAGCGGATTGAACGGCTTGGTTTCTCTGTCTGACTTGTCAAAGCTTCTTCTCCTCAAAG
ATGGGTGAGGTTACCTGCAAAAAACCCTCTGATGCCTAAGTTAGCACAAGAAAACTCTCAAGTGTCTGTAAAATGATTTTCTACGTACCTTTCATTAATGACCTCCATGAGACTTTATAATAGTTTGATTCAACTAATTTCATGGGTTTTCTCCAC
CTTTCTTGTCGTCTAAGATGGTGGACTTTGTTGGAGAAAATCATGGGAATTTCTCTAGGAGATTTTCAGTGGAGACTTGGTCTTCTATTGAAGAGATTTTTCCCACGTTGTCTCTGCATTTACTTCCTTATTTAATTCCTTCATTATCCTCTTAAT
TCTCAAAAATCAAAGGTTAAGAAATAAATGTTAAATAATTATCATTAATTAATAACAATGAGTCTCAAATTGAATGGGAAACAAAGAGATTTTGACTGGGCTTGTATTCCACGTGAAAATTCTTCCCAATTGCCATAACTCCTATTTATCTCATTG
TTAATAAATAAAATATTATTGAAATGTAATTATCATGAAATTGACTCCTTATCAAGATAGGTTATCAATAAATATTTATAAAATTTAAATGACACATCATCTTTGATTGAGTCATTGTTCTTCAAATGACAAATGGGAAATTGCCATGTGTCGCGG
TAATTTTGCTCCAACATAGAATATTCTAGCTTTAATTTGTATGAGTTTTGAGGAAGTCTCTAGAATTTTGTAGTATTTTCCAATAATGTGTATTAATTTTCAACAAATGTGAACCCACCAAAACAACACTGCCTAAGCTTCATGGTATTCCTGTTT
TACCCAAGGACAGTATAGCAGCCAAGGACAAGCTGAACACCACTGCTGGGTCTGGGAGAAAAGCCGCCAGTATGACTCTGGAAACCGCGTCTGTGTCGATGTAGACCATATGGACGGTCGACGTCGAGTGTCCTATATAGTCGACAAAGCCAATAT
ATTATAGTTGACGTCGACCATATGGACAGTCAAAAATATATTATGGTCGACGTTTATACATCAGTTTGGCTTTGTAAACCAAATTTAGATTTCAAATCTGTAAGGGACTTGTTTACTTTAAAGGATCAATAAGGACTTGTCTGGAAATTTCTCTAT
TTCCAGATATACCAGAAGGTCTGCAAATTTCTCAGTTTCTAGATATACCAGTAGACAAAGATGAACAATTATGTAGATTAGCAGCAAGCCAACTGTCCTAGTCTTAGATGCAGAAGGTTCCCAGGTAGACCAATAGCTTTCCACATTCTCCTGGCT
CTACCTTGGATTTTTTCCAAATTGCCTGCATAAATAGCTCTATAAACTCTGGAATGAACCACATGCATTCCCAAATACTTACCCTTAGCTTTATAAACTTTGTTTATAAACTTGCTACATATGTTTAGAGAAGCTTTTGTTGGGACGCATCAGGGT
AGAGTTAATTTCTTCCATGTTGCGTTTGGGTTTTTCTTTTGTTGGAGAGAGAGAGAGAGAAAGCAGAGATGAGTGAGAGGTTATGTGGGAAGATGAGAGAGAGGTTATGTGGGAAAATGAGAAAGCAGGTATATTCATTGATTTCAAAATAAGATG
TCATGACAAAAGGTAATAACGAAAAAATGTAAGGGGTAATTGAGAGTTTTCCTGTCTACAAAGTGTCTTTTTCTGCAAAGATTAGTGATGGTTCTAAATTTGAAAGGGGGGGAGACTATTCAGACCACCCAAAACCACTTAGTTGACCACCCCATT
AATTTTTTGCCCATTTTTTTTTTCCTATTTTGCCCCTGCATTAAAAAAAAACTCAGTTTTCCAATTTTGGCCGGCCACCCCTCCCCGCTACCGGCGCAACCCCACCCCCTCCCCACTGCCGGCGCGACCCCACCCCTCCTCTTCGCCGGTCGACCC
CACGCCTCCCCATCGCCGGCGCGACCCACCCACCCCTCCCCTTCTCTCTCTCTCTCTCTTCCCTCTCTCTGCCATCTTCTCTCTCTCCCCTCTCTCTACCTCCCTCCCTCACC
PREDICTED: Rosa chinensis probable amidase At4g34880 (LOC112173655), mRNA 

###############################################
# Blast bedGraph files to ncbi database  - see Ancient Cassiope BLAST

# BLAST

# run blast
cd /home/celphin/projects/rpp-rieseber/celphin/Dryas/DMRs/June2022_Metilene_DMRs/

module load StdEnv/2020
module load gcc/9.3.0
module load blast+/2.12.0

# https://www.metagenomics.wiki/tools/blast/blastn-output-format-6

blastn -db nt -query Total_DMRs_100-10-10_July2022_qval.1e-20_extended.fasta -out blast_Total_DMRs_100-10-10_July2022_qval.1e-20_extended.out -remote -outfmt "6 qseqid stitle"

more blast_Total_DMRs_100-10-10_July2022_qval.1e-20_extended.out

Do1_05_a00004:323760-325304 - syntaxin-71 
Do1_06_a00002:2717520-2718959 - POLYGALACTURONASE INVOLVED IN EXPANSION3 - AT1G48100.1
Do1_07_a00002:12442051-12443627 - NADH dehydrogenase subunit 4 gene, complete cds; mitochondrial


#------------------
***********
#Friday 
# try blast online - works to find same genes as before


# try more strict BLAST or less strict BLAST online
blastn -help

USAGE
  blastn [-h] [-help] [-import_search_strategy filename]
    [-export_search_strategy filename] [-task task_name] [-db database_name]
    [-dbsize num_letters] [-gilist filename] [-seqidlist filename]
    [-negative_gilist filename] [-negative_seqidlist filename]
    [-taxids taxids] [-negative_taxids taxids] [-taxidlist filename]
    [-negative_taxidlist filename] [-entrez_query entrez_query]
    [-db_soft_mask filtering_algorithm] [-db_hard_mask filtering_algorithm]
    [-subject subject_input_file] [-subject_loc range] [-query input_file]
    [-out output_file] [-evalue evalue] [-word_size int_value]
    [-gapopen open_penalty] [-gapextend extend_penalty]
    [-perc_identity float_value] [-qcov_hsp_perc float_value]
    [-max_hsps int_value] [-xdrop_ungap float_value] [-xdrop_gap float_value]
    [-xdrop_gap_final float_value] [-searchsp int_value]
    [-sum_stats bool_value] [-penalty penalty] [-reward reward] [-no_greedy]
    [-min_raw_gapped_score int_value] [-template_type type]
    [-template_length int_value] [-dust DUST_options]
    [-filtering_db filtering_database]
    [-window_masker_taxid window_masker_taxid]
    [-window_masker_db window_masker_db] [-soft_masking soft_masking]
    [-ungapped] [-culling_limit int_value] [-best_hit_overhang float_value]
    [-best_hit_score_edge float_value] [-subject_besthit]
    [-window_size int_value] [-off_diagonal_range int_value]
    [-use_index boolean] [-index_name string] [-lcase_masking]
    [-query_loc range] [-strand strand] [-parse_deflines] [-outfmt format]
    [-show_gis] [-num_descriptions int_value] [-num_alignments int_value]
    [-line_length line_length] [-html] [-sorthits sort_hits]
    [-sorthsps sort_hsps] [-max_target_seqs num_sequences]
    [-num_threads int_value] [-mt_mode int_value] [-remote] [-version]

blastn -db nt -query Total_DMRs_100-10-10_July2022_qval.1e-20_extended.fasta -out blast_Total_DMRs_100-10-10_July2022_qval.1e-20_extended.out -remote -outfmt "6 qseqid stitle" 
-evalue 0.05
-word_size 11
-gapopen 5
-gapextend 2
-penalty -3
-reward 2
-max_target_seqs 6

blastn -db nt -query Total_DMRs_100-10-10_July2022_qval.1e-20_extended.fasta -out blast_Total_DMRs_100-10-10_July2022_qval.1e-20_extended_settings_test.out -remote -outfmt "6 qseqid stitle" -evalue 0.05 -word_size 11 -gapopen 5 -gapextend 2 -penalty -3 -reward 2 -max_target_seqs 6

Error: [blastn] internal_error: (Severe Error) Blast search error: Details: search failed. # Informational Message: [blastsrv4.REAL]: Error: CPU usage limit was exceeded, resulting in SIGXCPU (24).

more blast_Total_DMRs_100-10-10_July2022_qval.1e-20_extended_settings_test.out


# finish Alex samples
- running now

# check for same Amidase gene
yes is there

# run sample/site overlaps and BLAST


###############################################
###############################################
###############################################
# Methyl Score
# https://www.biorxiv.org/content/10.1101/2022.01.06.475031v1
# https://github.com/Computomics/MethylScore

tmux new-session -s Dryas
tmux attach-session -t Dryas

cd /home/celphin/scratch/Dryas/

mkdir April_2022_MethylScore
cd April_2022_MethylScore/

#--------------------------------------------
# installation

module load singularity/3.7
module load StdEnv/2020
module load nextflow/20.10.0
module load java/1.8.0_192


#--------------------------------------------
# inputs

--SAMPLE_SHEET=/path/to/samplesheet.tsv 

sampleID 	path
S1 	/path/to/S1A.{bam,bedGraph}
S2 	/path/to/S2A.{bam,bedGraph}
S2 	/path/to/S2B.{bam,bedGraph}

# how to include sample information in the DMRs

--GENOME=/path/to/reference_genome.fa 


#--------------------------------------------
# try program
#salloc -c1 --time 23:00:00 --mem 120000m --account def-henryg

nextflow run Computomics/MethylScore --BEDGRAPH --SAMPLE_SHEET=/path/to/samplesheet.tsv --GENOME=/path/to/reference_genome.fa -profile docker



####################################
#other analysis
https://academic.oup.com/bioinformatics/article/36/17/4535/5850399

# look for trichome genes and check if difference
https://www.arabidopsis.org/servlets/TairObject?name=AT1G79840&type=locus 









